<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stretch Routine Builder</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ§˜</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
    <!-- Google Analytics - config injected by CI/CD -->
    <!-- __GA_SCRIPTS_START__
    <script async src="https://www.googletagmanager.com/gtag/js?id=__GOOGLE_ANALYTICS_ID__"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','__GOOGLE_ANALYTICS_ID__');</script>
    __GA_SCRIPTS_END__ -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: linear-gradient(to bottom right, #0f172a, #581c87, #0f172a);
            min-height: 100vh;
            padding: 1rem;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 0.75rem;
        }

        .title {
            font-family: 'Playfair Display', serif;
            font-size: 1.75rem;
            font-weight: 900;
            background: linear-gradient(to right, #d8b4fe, #fbcfe8, #d8b4fe);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 0.25rem;
        }

        /* Floating View Toggle (left side) */
        .floating-view-toggle {
            position: fixed;
            left: 0;
            top: 120px;
            z-index: 1001;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .float-btn {
            background: rgba(168, 85, 247, 0.7);
            border: 1px solid rgba(168, 85, 247, 0.9);
            border-left: none;
            color: white;
            padding: 0.5rem 0.4rem;
            border-radius: 0 0.5rem 0.5rem 0;
            cursor: pointer;
            font-size: 0.6rem;
            font-weight: 600;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            letter-spacing: 0.08em;
            transition: all 0.3s ease;
        }

        .float-btn:hover {
            background: rgba(168, 85, 247, 1);
            padding-left: 0.5rem;
        }

        .float-btn.active {
            background: linear-gradient(135deg, #a855f7, #ec4899);
        }

        .float-btn.zoom-btn {
            writing-mode: horizontal-tb;
            padding: 0.35rem 0.5rem;
            font-size: 0.75rem;
            letter-spacing: 0;
        }

        /* Floating Playback Controls (right top) */
        .floating-controls {
            position: fixed;
            top: 10px;
            right: 50px;
            z-index: 1001;
            display: flex;
            gap: 0.25rem;
            align-items: center;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(168, 85, 247, 0.4);
            border-radius: 2rem;
            padding: 0.3rem 0.6rem;
        }

        .fc-btn {
            background: rgba(168, 85, 247, 0.3);
            border: 1px solid rgba(168, 85, 247, 0.5);
            color: white;
            padding: 0.3rem 0.5rem;
            border-radius: 1rem;
            cursor: pointer;
            font-size: 0.6rem;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            white-space: nowrap;
        }

        .fc-btn:hover {
            background: rgba(168, 85, 247, 0.6);
        }

        .fc-btn .icon {
            width: 12px;
            height: 12px;
        }

        .fc-btn.danger {
            background: rgba(239, 68, 68, 0.3);
            border-color: rgba(239, 68, 68, 0.5);
        }

        .fc-btn.danger:hover {
            background: rgba(239, 68, 68, 0.6);
        }

        .fc-speed {
            display: flex;
            align-items: center;
            gap: 0.15rem;
            margin-left: 0.25rem;
            border-left: 1px solid rgba(255,255,255,0.15);
            padding-left: 0.4rem;
        }

        .fc-speed-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .fc-speed-btn:hover {
            background: rgba(168, 85, 247, 0.5);
        }

        .fc-speed-display {
            color: #4ade80;
            font-size: 0.7rem;
            font-weight: 600;
            min-width: 28px;
            text-align: center;
        }

        /* Usage stats badge (top right corner) */
        .usage-stats {
            position: fixed;
            top: 10px;
            right: 380px;
            z-index: 999;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(52, 211, 153, 0.3);
            border-radius: 1rem;
            padding: 0.25rem 0.6rem;
            display: flex;
            align-items: center;
            gap: 0.35rem;
            color: #86efac;
            font-size: 0.6rem;
            font-weight: 500;
        }

        .usage-stats .pulse-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #4ade80;
            animation: pulse 2s infinite;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Control Panel */
        .control-panel {
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .control-row {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .control-row:last-child {
            margin-bottom: 0;
        }

        .control-group {
            flex: 1;
            min-width: 200px;
        }

        .control-label {
            color: #d8b4fe;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            display: block;
            font-weight: 600;
        }

        .control-input {
            width: 100%;
            padding: 0.75rem;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.5rem;
            color: white;
            font-size: 0.875rem;
        }

        .control-select {
            width: 100%;
            padding: 0.75rem;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.5rem;
            color: white;
            font-size: 0.875rem;
            cursor: pointer;
        }

        .btn {
            background: linear-gradient(135deg, #a855f7, #ec4899);
            color: white;
            border: none;
            padding: 0.4rem 0.75rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.7rem;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            opacity: 0.85;
        }

        .btn:hover {
            opacity: 1;
            box-shadow: 0 4px 12px rgba(168, 85, 247, 0.3);
        }

        .btn .icon {
            width: 13px;
            height: 13px;
        }

        .btn.secondary {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .btn.danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        /* Playlist Sidebar (Left) */
        .playlist-sidebar-toggle {
            position: fixed;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(236, 72, 153, 0.6);
            border: 1px solid rgba(236, 72, 153, 0.8);
            border-left: none;
            color: white;
            padding: 0.75rem 0.35rem;
            border-radius: 0 0.5rem 0.5rem 0;
            cursor: pointer;
            z-index: 1001;
            font-size: 0.75rem;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            letter-spacing: 0.1em;
            transition: all 0.3s ease;
        }

        .playlist-sidebar-toggle:hover {
            background: rgba(236, 72, 153, 0.9);
            padding-left: 0.5rem;
        }

        .playlist-sidebar {
            position: fixed;
            left: -360px;
            top: 0;
            width: 340px;
            height: 100vh;
            background: linear-gradient(180deg, #1e1b4b 0%, #0f172a 100%);
            border-right: 1px solid rgba(236, 72, 153, 0.3);
            z-index: 1003;
            overflow-y: auto;
            padding: 1rem;
            transition: left 0.3s ease;
        }

        .playlist-sidebar.open {
            left: 0;
        }

        .pl-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .pl-header-title {
            color: #fbcfe8;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .pl-close {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 0.25rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .pl-close:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        .pl-section-label {
            color: #f9a8d4;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 0.5rem;
            margin-top: 0.75rem;
        }

        .pl-entry {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            padding: 0.6rem 0.75rem;
            margin-bottom: 0.4rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pl-entry:hover {
            background: rgba(236, 72, 153, 0.15);
            border-color: rgba(236, 72, 153, 0.4);
        }

        .pl-entry.active {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(236, 72, 153, 0.2));
            border-color: rgba(236, 72, 153, 0.6);
        }

        .pl-entry-info {
            flex: 1;
            min-width: 0;
        }

        .pl-entry-name {
            color: white;
            font-size: 0.8rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .pl-entry-meta {
            color: #c4b5fd;
            font-size: 0.6rem;
            margin-top: 0.15rem;
        }

        .pl-entry-actions {
            display: flex;
            gap: 0.25rem;
            flex-shrink: 0;
            margin-left: 0.5rem;
        }

        .pl-entry-btn {
            background: none;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            padding: 0.2rem;
            font-size: 0.7rem;
            border-radius: 0.2rem;
            transition: all 0.2s;
        }

        .pl-entry-btn:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }

        .pl-entry-btn.delete:hover {
            color: #fca5a5;
            background: rgba(239, 68, 68, 0.2);
        }

        .pl-auth-bar {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            padding: 0.6rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .pl-auth-bar .avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
        }

        .pl-auth-bar .user-email {
            color: #e2e8f0;
            font-size: 0.7rem;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .pl-auth-btn {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: #e2e8f0;
            padding: 0.35rem 0.6rem;
            border-radius: 0.3rem;
            cursor: pointer;
            font-size: 0.65rem;
            transition: all 0.2s;
        }

        .pl-auth-btn:hover {
            background: rgba(168, 85, 247, 0.2);
        }

        .pl-google-btn {
            background: white;
            color: #333;
            border: 1px solid #dadce0;
            padding: 0.4rem 0.75rem;
            border-radius: 0.3rem;
            cursor: pointer;
            font-size: 0.7rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            width: 100%;
            justify-content: center;
            transition: all 0.2s;
        }

        .pl-google-btn:hover {
            background: #f8f9fa;
            box-shadow: 0 1px 3px rgba(0,0,0,0.15);
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.open {
            display: flex;
        }

        .modal {
            background: linear-gradient(180deg, #1e1b4b, #0f172a);
            border: 1px solid rgba(168, 85, 247, 0.4);
            border-radius: 0.75rem;
            padding: 1.5rem;
            width: 90%;
            max-width: 400px;
        }

        .modal h3 {
            color: white;
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        .modal-input {
            width: 100%;
            padding: 0.6rem 0.75rem;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.4rem;
            color: white;
            font-size: 0.8rem;
            margin-bottom: 0.75rem;
        }

        .modal-input:focus {
            outline: none;
            border-color: rgba(168, 85, 247, 0.6);
        }

        .modal-btns {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        /* Settings Sidebar (Right) */
        .sidebar-toggle {
            position: fixed;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(168, 85, 247, 0.6);
            border: 1px solid rgba(168, 85, 247, 0.8);
            border-right: none;
            color: white;
            padding: 0.75rem 0.35rem;
            border-radius: 0.5rem 0 0 0.5rem;
            cursor: pointer;
            z-index: 1001;
            font-size: 0.75rem;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            letter-spacing: 0.1em;
            transition: all 0.3s ease;
        }

        .sidebar-toggle:hover {
            background: rgba(168, 85, 247, 0.9);
            padding-right: 0.5rem;
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 1002;
        }

        .sidebar-overlay.open {
            display: block;
        }

        .sidebar {
            position: fixed;
            right: -340px;
            top: 0;
            width: 320px;
            height: 100vh;
            background: linear-gradient(180deg, #1e1b4b 0%, #0f172a 100%);
            border-left: 1px solid rgba(168, 85, 247, 0.3);
            z-index: 1003;
            overflow-y: auto;
            padding: 1rem;
            transition: right 0.3s ease;
        }

        .sidebar.open {
            right: 0;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.25rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-title {
            color: #d8b4fe;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .sidebar-close {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 0.25rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .sidebar-close:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        .sidebar-section {
            margin-bottom: 1.25rem;
        }

        .sidebar-section-title {
            color: #a78bfa;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 0.5rem;
        }

        .sidebar-btn-group {
            display: flex;
            flex-direction: column;
            gap: 0.375rem;
        }

        .sidebar-btn {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.12);
            color: #e2e8f0;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
            width: 100%;
            text-align: left;
        }

        .sidebar-btn:hover {
            background: rgba(168, 85, 247, 0.2);
            border-color: rgba(168, 85, 247, 0.4);
        }

        .sidebar-btn .icon {
            width: 14px;
            height: 14px;
            flex-shrink: 0;
        }

        .sidebar-select {
            width: 100%;
            padding: 0.5rem;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 0.375rem;
            color: white;
            font-size: 0.75rem;
            cursor: pointer;
        }

        .sidebar-label {
            color: #c4b5fd;
            font-size: 0.7rem;
            margin-bottom: 0.35rem;
            display: block;
        }

        /* Compact Grid */
        .stretch-grid.layout-compact {
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 0.5rem;
        }

        .stretch-card.compact {
            padding: 0.375rem;
            border-radius: 0.5rem;
        }

        .stretch-card.compact .stretch-header {
            margin-bottom: 0.25rem;
        }

        .stretch-card.compact .stretch-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stretch-card.compact .stretch-number {
            font-size: 0.85rem;
            font-weight: 700;
            margin-bottom: 0;
            min-width: 1.5rem;
        }

        .stretch-card.compact .stretch-name {
            font-size: 0.75rem;
            margin-bottom: 0;
        }

        .stretch-card.compact .stretch-duration,
        .stretch-card.compact .stretch-description,
        .stretch-card.compact .stretch-controls,
        .stretch-card.compact .slider-group {
            display: none;
        }

        .stretch-card.compact .video-wrapper {
            margin-bottom: 0;
        }

        .stretch-card.compact:hover {
            transform: none;
        }

        /* Main Video Player */
        .main-player {
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .main-player.position-top {
            order: -1;
        }

        .main-player.position-bottom {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            max-width: 100%;
            z-index: 1000;
            border-radius: 0;
            padding: 0.75rem 1.5rem;
            margin-bottom: 0;
            border: none;
            border-top: 2px solid rgba(168, 85, 247, 0.5);
            background: linear-gradient(180deg, rgba(15, 23, 42, 0.98), rgba(30, 27, 75, 0.98));
            backdrop-filter: blur(20px);
        }

        .main-player.position-bottom .sequential-container {
            flex-direction: row;
            align-items: center;
            gap: 1rem;
        }

        .main-player.position-bottom .player-section {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex: 1;
            min-width: 0;
        }

        .main-player.position-bottom .main-info {
            text-align: left;
            margin-bottom: 0;
            min-width: 0;
            flex: 1;
        }

        .main-player.position-bottom .main-title {
            font-size: 0.9rem;
            margin-bottom: 0.15rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .main-player.position-bottom .main-progress {
            font-size: 0.7rem;
        }

        .main-player.position-bottom .main-controls {
            flex-wrap: nowrap;
            gap: 0.5rem;
        }

        .main-player.position-bottom .main-controls .btn {
            padding: 0.3rem 0.5rem;
            font-size: 0.65rem;
        }

        .main-player.position-bottom .pause-control {
            display: none;
        }

        .main-player.position-bottom .playlist-panel {
            display: none;
        }

        .main-player.hidden {
            display: none;
        }

        .main-video-wrapper {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin: 0 auto 1rem auto;
            padding-bottom: 45%;
            background: #000;
            border-radius: 0.75rem;
            overflow: hidden;
        }

        .main-player.position-bottom .main-video-wrapper {
            width: 200px;
            max-width: 200px;
            padding-bottom: 112px;
            margin: 0;
            flex-shrink: 0;
            border-radius: 0.5rem;
        }

        .sequential-container {
            display: flex;
            gap: 1.5rem;
            align-items: flex-start;
        }

        .player-section {
            flex: 1;
            min-width: 0;
        }

        .playlist-panel {
            width: 350px;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1rem;
            padding: 1rem;
            max-height: 600px;
            overflow-y: auto;
        }

        .playlist-title {
            color: #d8b4fe;
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .playlist-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .playlist-item:hover {
            background: rgba(168, 85, 247, 0.2);
            border-color: rgba(168, 85, 247, 0.5);
        }

        .playlist-item.current {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.3), rgba(236, 72, 153, 0.3));
            border-color: rgba(168, 85, 247, 0.8);
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.4);
        }

        .playlist-item.completed {
            background: rgba(34, 197, 94, 0.1);
            border-color: rgba(34, 197, 94, 0.3);
            opacity: 0.7;
        }

        .playlist-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.25rem;
        }

        .playlist-item-number {
            color: #d8b4fe;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .playlist-item-name {
            color: white;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .playlist-item-info {
            color: #e9d5ff;
            font-size: 0.7rem;
            display: flex;
            gap: 0.5rem;
        }

        .playlist-item-repeat {
            background: rgba(168, 85, 247, 0.3);
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-size: 0.65rem;
            font-weight: 600;
        }

        .playlist-item.current .playlist-item-repeat {
            background: rgba(236, 72, 153, 0.5);
            animation: pulse 1.5s infinite;
        }

        .pause-control {
            background: rgba(168, 85, 247, 0.2);
            border: 1px solid rgba(168, 85, 247, 0.3);
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-top: 1rem;
        }

        .pause-label {
            color: #d8b4fe;
            font-size: 0.75rem;
            margin-bottom: 0.5rem;
            display: block;
        }

        .pause-input-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .pause-input {
            width: 60px;
            padding: 0.5rem;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.25rem;
            color: white;
            font-size: 0.875rem;
            text-align: center;
        }

        .preset-configs {
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .preset-title {
            color: #d8b4fe;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .preset-list {
            display: grid;
            gap: 0.75rem;
        }

        .preset-item {
            background: rgba(168, 85, 247, 0.1);
            border: 2px solid rgba(168, 85, 247, 0.3);
            border-radius: 0.75rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .preset-item:hover {
            background: rgba(168, 85, 247, 0.2);
            border-color: rgba(168, 85, 247, 0.6);
            transform: translateY(-2px);
        }

        .preset-item.active {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.3), rgba(236, 72, 153, 0.3));
            border-color: rgba(168, 85, 247, 0.8);
        }

        .preset-item-name {
            color: white;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .preset-item-desc {
            color: #e9d5ff;
            font-size: 0.75rem;
            margin-bottom: 0.25rem;
        }

        .preset-item-info {
            color: #c4b5fd;
            font-size: 0.7rem;
        }

        .grid-management-btns {
            display: flex;
            gap: 0.25rem;
            margin-top: 0.5rem;
        }

        .grid-mgmt-btn {
            background: rgba(168, 85, 247, 0.3);
            border: 1px solid rgba(168, 85, 247, 0.5);
            border-radius: 0.25rem;
            color: white;
            padding: 0.25rem 0.5rem;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .grid-mgmt-btn:hover {
            background: rgba(168, 85, 247, 0.5);
            border-color: rgba(168, 85, 247, 0.8);
        }

        .grid-mgmt-btn.danger {
            background: rgba(239, 68, 68, 0.3);
            border-color: rgba(239, 68, 68, 0.5);
        }

        .grid-mgmt-btn.danger:hover {
            background: rgba(239, 68, 68, 0.5);
            border-color: rgba(239, 68, 68, 0.8);
        }

        @media (max-width: 1024px) {
            .sequential-container {
                flex-direction: column;
            }
            .playlist-panel {
                width: 100%;
                max-height: 400px;
            }
        }

        .main-video-wrapper iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .main-info {
            text-align: center;
            color: white;
            margin-bottom: 1rem;
        }

        .main-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .main-progress {
            font-size: 1rem;
            color: #e9d5ff;
        }

        .main-controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        /* Stretch Grid */
        .stretch-grid {
            display: grid;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stretch-grid.layout-2x5 {
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        }

        .stretch-grid.layout-5x2 {
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        }

        .stretch-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 1rem;
            padding: 1rem;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stretch-card:hover {
            transform: translateY(-4px);
            border-color: rgba(168, 85, 247, 0.5);
            box-shadow: 0 10px 40px rgba(168, 85, 247, 0.3);
        }

        .stretch-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.75rem;
        }

        .stretch-info {
            flex: 1;
        }

        .stretch-number {
            color: #d8b4fe;
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .stretch-name {
            font-size: 1rem;
            font-weight: 600;
            color: white;
            margin-bottom: 0.25rem;
        }

        .stretch-duration {
            color: #e9d5ff;
            font-size: 0.7rem;
        }

        .video-wrapper {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%;
            background: #000;
            border-radius: 0.5rem;
            overflow: hidden;
            margin-bottom: 0.75rem;
        }

        .video-wrapper iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .timer-badge {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: rgba(0, 0, 0, 0.8);
            color: #4ade80;
            padding: 0.25rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            z-index: 10;
        }

        .playing-indicator {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ef4444;
            z-index: 10;
            animation: pulse 1.5s infinite;
        }

        .stretch-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .sound-toggle {
            background: rgba(168, 85, 247, 0.3);
            border: 1px solid rgba(168, 85, 247, 0.5);
            color: white;
            padding: 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sound-toggle:hover {
            background: rgba(168, 85, 247, 0.5);
        }

        .sound-toggle.unmuted {
            background: rgba(34, 197, 94, 0.5);
            border-color: rgba(34, 197, 94, 0.7);
        }

        .loop-toggle {
            background: rgba(168, 85, 247, 0.3);
            border: 1px solid rgba(168, 85, 247, 0.5);
            color: white;
            padding: 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.75rem;
        }

        .loop-toggle.active {
            background: rgba(34, 197, 94, 0.5);
            border-color: rgba(34, 197, 94, 0.7);
        }

        /* Sliders */
        .slider-group {
            margin-top: 0.75rem;
        }

        .slider-group.hidden {
            display: none;
        }

        .slider-label {
            color: #d8b4fe;
            font-size: 0.7rem;
            margin-bottom: 0.25rem;
            display: flex;
            justify-content: space-between;
        }

        .slider {
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            margin-bottom: 0.5rem;
        }

        .slider::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #a855f7;
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #a855f7;
            cursor: pointer;
            border: none;
        }

        .repeat-input {
            width: 60px;
            padding: 0.25rem 0.5rem;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.25rem;
            color: white;
            font-size: 0.75rem;
            text-align: center;
        }

        .icon {
            width: 16px;
            height: 16px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .file-upload {
            position: relative;
            display: inline-block;
        }

        .file-upload input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        /* Bottom player grid padding */
        body.player-bottom {
            padding-bottom: 160px;
        }

        /* Playback Speed Controls */
        .speed-control {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .speed-btn {
            background: rgba(168, 85, 247, 0.3);
            border: 1px solid rgba(168, 85, 247, 0.5);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            cursor: pointer;
            font-size: 0.7rem;
            transition: all 0.2s ease;
            min-width: 36px;
            text-align: center;
        }

        .speed-btn:hover {
            background: rgba(168, 85, 247, 0.5);
        }

        .speed-btn.active {
            background: rgba(34, 197, 94, 0.5);
            border-color: rgba(34, 197, 94, 0.7);
        }

        .speed-display {
            color: #4ade80;
            font-size: 0.8rem;
            font-weight: 600;
            min-width: 40px;
            text-align: center;
        }

        .main-player.position-bottom .speed-control {
            margin-top: 0;
        }

        /* YouTube Parser Modal */
        .parser-modal {
            background: linear-gradient(180deg, #1e1b4b, #0f172a);
            border: 1px solid rgba(168, 85, 247, 0.4);
            border-radius: 0.75rem;
            padding: 1.5rem;
            width: 95%;
            max-width: 700px;
            max-height: 85vh;
            overflow-y: auto;
        }

        .parser-modal h3 {
            color: white;
            font-size: 1.1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .parser-input-group {
            margin-bottom: 1rem;
        }

        .parser-input-group label {
            color: #d8b4fe;
            font-size: 0.75rem;
            display: block;
            margin-bottom: 0.35rem;
            font-weight: 600;
        }

        .parser-input-group textarea {
            width: 100%;
            padding: 0.6rem 0.75rem;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.4rem;
            color: white;
            font-size: 0.8rem;
            font-family: monospace;
            resize: vertical;
        }

        .parser-input-group textarea:focus {
            outline: none;
            border-color: rgba(168, 85, 247, 0.6);
        }

        .parser-input-group input[type="text"],
        .parser-input-group input[type="password"] {
            width: 100%;
            padding: 0.6rem 0.75rem;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.4rem;
            color: white;
            font-size: 0.8rem;
        }

        .parser-input-group input:focus {
            outline: none;
            border-color: rgba(168, 85, 247, 0.6);
        }

        .parser-hint {
            color: #94a3b8;
            font-size: 0.65rem;
            margin-top: 0.25rem;
            line-height: 1.4;
        }

        .parser-results {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .parser-exercise-item {
            background: rgba(168, 85, 247, 0.1);
            border: 1px solid rgba(168, 85, 247, 0.3);
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .parser-exercise-item .exercise-name {
            color: white;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .parser-exercise-item .exercise-time {
            color: #4ade80;
            font-size: 0.7rem;
            margin-bottom: 0.25rem;
        }

        .parser-exercise-item .exercise-desc {
            color: #c4b5fd;
            font-size: 0.7rem;
            line-height: 1.3;
        }

        .parser-loading {
            text-align: center;
            padding: 2rem;
            color: #d8b4fe;
        }

        .parser-loading .spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(168, 85, 247, 0.3);
            border-top: 3px solid #a855f7;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 0.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .parser-api-row {
            display: flex;
            gap: 0.5rem;
            align-items: flex-end;
        }

        .parser-api-row .parser-input-group {
            flex: 1;
            margin-bottom: 0;
        }

        .parser-api-row .btn {
            margin-bottom: 0;
            white-space: nowrap;
            height: fit-content;
        }

        /* Parser mode toggle */
        .parser-mode-toggle {
            display: flex;
            gap: 0;
            margin-bottom: 1rem;
            border: 1px solid rgba(168, 85, 247, 0.4);
            border-radius: 0.5rem;
            overflow: hidden;
        }

        .parser-mode-btn {
            flex: 1;
            padding: 0.5rem 0.75rem;
            background: rgba(255,255,255,0.05);
            border: none;
            color: #94a3b8;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .parser-mode-btn:hover {
            background: rgba(168, 85, 247, 0.15);
        }

        .parser-mode-btn.active {
            background: linear-gradient(135deg, #a855f7, #ec4899);
            color: white;
        }

        .parser-mode-content {
            display: none;
        }

        .parser-mode-content.active {
            display: block;
        }

        .text-format-help {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 0.4rem;
            padding: 0.6rem;
            margin-top: 0.5rem;
            font-size: 0.65rem;
            color: #94a3b8;
            line-height: 1.5;
            font-family: monospace;
        }

        .api-key-section {
            background: rgba(168, 85, 247, 0.08);
            border: 1px solid rgba(168, 85, 247, 0.2);
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 1rem;
        }

        .api-key-section .key-label {
            color: #d8b4fe;
            font-size: 0.7rem;
            font-weight: 600;
            margin-bottom: 0.35rem;
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }

        .api-key-section .key-status {
            font-size: 0.6rem;
            padding: 0.1rem 0.4rem;
            border-radius: 1rem;
        }

        .api-key-section .key-status.active {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
        }

        .api-key-section .key-status.inactive {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        /* Category badges */
        .category-badge {
            display: inline-block;
            padding: 0.125rem 0.5rem;
            border-radius: 1rem;
            font-size: 0.6rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .category-badge.warmup { background: rgba(251, 191, 36, 0.3); color: #fbbf24; border: 1px solid rgba(251, 191, 36, 0.5); }
        .category-badge.flexibility { background: rgba(96, 165, 250, 0.3); color: #60a5fa; border: 1px solid rgba(96, 165, 250, 0.5); }
        .category-badge.strength { background: rgba(239, 68, 68, 0.3); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.5); }
        .category-badge.balance { background: rgba(52, 211, 153, 0.3); color: #34d399; border: 1px solid rgba(52, 211, 153, 0.5); }
        .category-badge.cooldown { background: rgba(167, 139, 250, 0.3); color: #a78bfa; border: 1px solid rgba(167, 139, 250, 0.5); }

        /* Add Exercise card */
        .add-exercise-card {
            background: rgba(168, 85, 247, 0.08);
            border: 2px dashed rgba(168, 85, 247, 0.4);
            border-radius: 1rem;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 200px;
        }

        .add-exercise-card:hover {
            background: rgba(168, 85, 247, 0.15);
            border-color: rgba(168, 85, 247, 0.7);
            transform: translateY(-4px);
        }

        .add-exercise-card .add-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(168, 85, 247, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #d8b4fe;
            font-size: 1.5rem;
            margin-bottom: 0.75rem;
        }

        .add-exercise-card .add-text {
            color: #d8b4fe;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .add-exercise-card .add-subtext {
            color: #94a3b8;
            font-size: 0.7rem;
            margin-top: 0.25rem;
        }

        /* Routine summary bar */
        .routine-summary {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.15), rgba(236, 72, 153, 0.15));
            border: 1px solid rgba(168, 85, 247, 0.3);
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .routine-summary .summary-item {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            color: #e9d5ff;
            font-size: 0.75rem;
        }

        .routine-summary .summary-value {
            color: #4ade80;
            font-weight: 600;
        }

        .routine-summary .summary-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Difficulty indicator */
        .difficulty-dots {
            display: inline-flex;
            gap: 3px;
            margin-left: 0.5rem;
        }

        .difficulty-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
        }

        .difficulty-dot.filled {
            background: #fbbf24;
        }

        /* Zoom levels */
        .stretch-grid.zoom-small.layout-2x5 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        .stretch-grid.zoom-small.layout-5x2 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
        .stretch-grid.zoom-small .stretch-card { padding: 0.6rem; }
        .stretch-grid.zoom-small .stretch-name { font-size: 0.85rem; }
        .stretch-grid.zoom-small .video-wrapper { padding-bottom: 45%; }

        .stretch-grid.zoom-large.layout-2x5 { grid-template-columns: repeat(auto-fit, minmax(550px, 1fr)); }
        .stretch-grid.zoom-large.layout-5x2 { grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); }
        .stretch-grid.zoom-large .stretch-card { padding: 1.5rem; }
        .stretch-grid.zoom-large .stretch-name { font-size: 1.2rem; }

        @media (max-width: 768px) {
            .title {
                font-size: 1.5rem;
            }
            .stretch-grid.layout-2x5,
            .stretch-grid.layout-5x2 {
                grid-template-columns: 1fr;
            }
            .stretch-grid.layout-compact {
                grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            }
            .sidebar {
                width: 280px;
                right: -300px;
            }
            .playlist-sidebar {
                width: 280px;
                left: -300px;
            }
            .main-player.position-bottom .sequential-container {
                flex-direction: column;
            }
            .main-player.position-bottom .player-section {
                flex-direction: column;
            }
            .main-player.position-bottom .main-video-wrapper {
                width: 100%;
                max-width: 100%;
                padding-bottom: 40%;
            }
            body.player-bottom {
                padding-bottom: 280px;
            }
            .floating-controls {
                top: auto;
                bottom: 170px;
                right: 10px;
                flex-wrap: wrap;
                max-width: 280px;
            }
            .usage-stats {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1 class="title">Stretch Routine Builder</h1>
        </div>

        <!-- Floating View Toggle (Left) -->
        <div class="floating-view-toggle">
            <button class="float-btn active" id="gridViewBtn" onclick="setViewMode('grid')">Grid</button>
            <button class="float-btn" id="compactViewBtn" onclick="setViewMode('compact')">Compact</button>
            <button class="float-btn zoom-btn" onclick="zoomGrid(-1)" title="Zoom Out">-</button>
            <button class="float-btn zoom-btn" onclick="zoomGrid(1)" title="Zoom In">+</button>
        </div>

        <!-- Floating Playback Controls (Right Top) -->
        <div class="floating-controls">
            <button class="fc-btn" onclick="playAllGrid()" title="Play All Muted">
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/></svg>
                Play All
            </button>
            <button class="fc-btn danger" onclick="stopAllGrid()" title="Stop All">
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6"/></svg>
                Stop
            </button>
            <button class="fc-btn" onclick="muteAllGrid()" title="Mute All">
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"/></svg>
                Mute
            </button>
            <div class="fc-speed">
                <button class="fc-speed-btn" onclick="changePlaybackSpeed(-0.25)">-</button>
                <span class="fc-speed-display" id="fcSpeedDisplay">1x</span>
                <button class="fc-speed-btn" onclick="changePlaybackSpeed(0.25)">+</button>
            </div>
        </div>

        <!-- Usage Stats Badge -->
        <div class="usage-stats" id="usageStats">
            <span class="pulse-dot"></span>
            <span id="usageText">Loading stats...</span>
        </div>

        <!-- Hidden layout select for config compatibility -->
        <select id="layoutSelect" onchange="changeLayout()" style="display:none;">
            <option value="2x5">2x5</option>
            <option value="5x2" selected>5x2</option>
        </select>
        <input type="file" id="configUpload" accept=".json" onchange="loadConfig(event)" style="display: none;">
        <textarea id="configPreview" style="display:none;"></textarea>

        <!-- Grid View -->
        <div id="grid-tab" class="tab-content active">
            <!-- Sequential Player (embedded in grid view) -->
            <div class="main-player position-bottom" id="sequentialPlayer">
                <div class="sequential-container">
                    <div class="player-section">
                        <div class="main-video-wrapper">
                            <div id="mainPlayer"></div>
                        </div>
                        
                        <div class="main-info">
                            <div class="main-title" id="mainTitle">Sequential Player</div>
                            <div class="main-progress" id="mainProgress">Press Start to begin sequential playback</div>
                        </div>
                        
                        <div class="main-controls">
                            <button class="btn" onclick="startSequential()">
                                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                Start Sequential
                            </button>
                            
                            <button class="btn danger" onclick="stopSequential()">
                                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"/>
                                </svg>
                                Stop
                            </button>
                            
                            <button class="btn" onclick="skipNext()">
                                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"/>
                                </svg>
                                Skip Next
                            </button>

                            <div class="speed-control">
                                <button class="speed-btn" onclick="changePlaybackSpeed(-0.25)">-</button>
                                <span class="speed-display" id="speedDisplay">1x</span>
                                <button class="speed-btn" onclick="changePlaybackSpeed(0.25)">+</button>
                            </div>
                        </div>

                        <div class="pause-control">
                            <label class="pause-label">Pause Between Repeats (same stretch)</label>
                            <div class="pause-input-group">
                                <input type="number" class="pause-input" id="pauseRepeat" value="2" min="0" max="30" step="1">
                                <span style="color: #e9d5ff; font-size: 0.75rem;">seconds between repeats</span>
                            </div>
                            
                            <label class="pause-label" style="margin-top: 1rem;">Pause Between Videos (different stretches)</label>
                            <div class="pause-input-group">
                                <input type="number" class="pause-input" id="pauseVideo" value="3" min="0" max="30" step="1">
                                <span style="color: #e9d5ff; font-size: 0.75rem;">seconds between videos</span>
                            </div>

                            <label class="pause-label" style="margin-top: 1rem;">Overall Sequence Repeats</label>
                            <div class="pause-input-group">
                                <input type="number" class="pause-input" id="overallRepeats" value="2" min="1" max="10" step="1">
                                <span style="color: #e9d5ff; font-size: 0.75rem;">times to repeat entire routine</span>
                            </div>
                        </div>
                    </div>

                    <div class="playlist-panel">
                        <div class="playlist-title">Playlist & Progress</div>
                        <div id="playlistItems"></div>
                    </div>
                </div>
            </div>

            <!-- Playlist Sidebar Toggle (Left) -->
            <button class="playlist-sidebar-toggle" onclick="togglePlaylistSidebar()">Playlists</button>

            <!-- Playlist Sidebar Overlay -->
            <div class="sidebar-overlay" id="plSidebarOverlay" onclick="togglePlaylistSidebar()"></div>

            <!-- Playlist Sidebar -->
            <div class="playlist-sidebar" id="playlistSidebar">
                <div class="pl-header">
                    <span class="pl-header-title">Playlists</span>
                    <button class="pl-close" onclick="togglePlaylistSidebar()">&times;</button>
                </div>

                <!-- Auth Bar -->
                <div class="pl-auth-bar" id="authBar">
                    <div id="authContent">
                        <button class="pl-google-btn" onclick="signInWithGoogle()">
                            <svg width="16" height="16" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 01-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                            Sign in with Google
                        </button>
                    </div>
                </div>

                <!-- Built-in Playlists -->
                <div class="pl-section-label">Built-in Playlists</div>
                <div id="builtinPlaylistList"></div>

                <!-- User Playlists (localStorage) -->
                <div class="pl-section-label">My Playlists (Local)</div>
                <div id="userPlaylistList"></div>

                <!-- Private Playlists (requires sign-in) -->
                <div class="pl-section-label" id="privatePlaylistLabel" style="display:none;">My Playlists (Cloud)</div>
                <div id="privatePlaylistList"></div>
            </div>

            <!-- Save Playlist Modal -->
            <div class="modal-overlay" id="saveModal">
                <div class="modal">
                    <h3>Save as Playlist</h3>
                    <input type="text" class="modal-input" id="savePlaylistName" placeholder="Playlist name (e.g. Morning Stretch)">
                    <input type="text" class="modal-input" id="savePlaylistDesc" placeholder="Short description (optional)">
                    <div style="margin-bottom: 0.75rem;">
                        <label style="color: #c4b5fd; font-size: 0.7rem; display: flex; align-items: center; gap: 0.4rem; cursor: pointer;">
                            <input type="checkbox" id="saveToCloud" style="display:none;" disabled>
                            <span id="cloudCheckbox" style="display:inline-block; width:14px; height:14px; border:1px solid rgba(255,255,255,0.3); border-radius:3px; background:rgba(0,0,0,0.3); opacity:0.4;"></span>
                            Save to cloud (sign in required)
                        </label>
                    </div>
                    <div class="modal-btns">
                        <button class="btn" style="background: rgba(255,255,255,0.1);" onclick="closeSaveModal()">Cancel</button>
                        <button class="btn" onclick="confirmSavePlaylist()">Save</button>
                    </div>
                </div>
            </div>

            <!-- YouTube Parser Modal (Dual Mode) -->
            <div class="modal-overlay" id="parserModal">
                <div class="parser-modal">
                    <h3>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ff0000" stroke-width="2"><path d="M22.54 6.42a2.78 2.78 0 00-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 00-1.94 2A29 29 0 001 11.75a29 29 0 00.46 5.33A2.78 2.78 0 003.4 19.1c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 001.94-2 29 29 0 00.46-5.25 29 29 0 00-.46-5.43z"/><polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02" fill="#ff0000" stroke="none"/></svg>
                        YouTube Exercise Parser
                        <button class="pl-close" onclick="closeParserModal()" style="margin-left:auto;">&times;</button>
                    </h3>

                    <!-- Mode Toggle -->
                    <div class="parser-mode-toggle">
                        <button class="parser-mode-btn active" onclick="switchParserMode('manual')">Manual URLs</button>
                        <button class="parser-mode-btn" onclick="switchParserMode('ai')">AI Transcript</button>
                        <button class="parser-mode-btn" onclick="switchParserMode('text')">Text Format</button>
                    </div>

                    <!-- API Key Section -->
                    <div class="api-key-section">
                        <div class="key-label">
                            Google API Key
                            <span class="key-status" id="apiKeyStatus">Not set</span>
                        </div>
                        <div id="masterKeyInfo" style="display:none; color:#4ade80; font-size:0.6rem; margin-bottom:0.35rem;">Using master key (signed in)</div>
                        <input type="password" id="parserApiKey" placeholder="Enter your Google / Gemini API key" style="width:100%; padding:0.5rem; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.15); border-radius:0.3rem; color:white; font-size:0.75rem;">
                        <div class="parser-hint" style="margin-top:0.25rem;">
                            Used for AI parsing and YouTube data. Stored locally.
                            <a href="https://ai.google.dev/gemini-api/docs/api-key" target="_blank" style="color:#a855f7;">Get free key</a>
                        </div>
                    </div>

                    <!-- Mode 1: Manual URL Input -->
                    <div class="parser-mode-content active" id="parserManualMode">
                        <div class="parser-input-group">
                            <label>YouTube URL(s)</label>
                            <textarea id="parserUrls" rows="3" placeholder="Paste one or more YouTube URLs (one per line)&#10;e.g. https://www.youtube.com/watch?v=0wAw1-1MHa4"></textarea>
                            <div class="parser-hint">Enter YouTube video URLs. Each URL creates an editable exercise entry in the grid.</div>
                        </div>

                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                            <button class="btn" onclick="parseManualUrls()">
                                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
                                Add Videos to Grid
                            </button>
                            <button class="btn" style="background: rgba(255,255,255,0.1);" onclick="closeParserModal()">Cancel</button>
                        </div>
                    </div>

                    <!-- Mode 2: AI Transcript Parser -->
                    <div class="parser-mode-content" id="parserAiMode">
                        <div class="parser-input-group">
                            <label>YouTube URL(s)</label>
                            <textarea id="parserAiUrls" rows="2" placeholder="Paste YouTube URL(s) for video ID reference"></textarea>
                        </div>

                        <div class="parser-input-group">
                            <label>Video Transcript / Captions</label>
                            <textarea id="parserTranscript" rows="8" placeholder="Paste the video transcript here...&#10;&#10;To get the transcript from YouTube:&#10;1. Open the video on YouTube&#10;2. Click '...' (More) below the video&#10;3. Click 'Show transcript'&#10;4. Copy and paste the transcript text here"></textarea>
                            <div class="parser-hint">Paste the transcript with timestamps. The AI will identify each exercise with its start and end time.</div>
                        </div>

                        <div class="parser-input-group">
                            <label>Context</label>
                            <select id="parserContext" style="width:100%; padding:0.5rem; background:rgba(0,0,0,0.4); border:1px solid rgba(255,255,255,0.2); border-radius:0.4rem; color:white; font-size:0.8rem;">
                                <option value="general">General Exercise / Stretch</option>
                                <option value="physiotherapy">Physiotherapy / Rehabilitation</option>
                                <option value="gym">Gym / Strength Training</option>
                                <option value="dance">Dance Practice / Choreography</option>
                                <option value="yoga">Yoga / Meditation</option>
                            </select>
                        </div>

                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                            <button class="btn" onclick="parseYouTubeExercises()" id="parseBtn">
                                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                                Parse with AI
                            </button>
                            <button class="btn" style="background: rgba(255,255,255,0.1);" onclick="closeParserModal()">Cancel</button>
                        </div>
                    </div>

                    <!-- Mode 3: Text Format Parser -->
                    <div class="parser-mode-content" id="parserTextMode">
                        <div class="parser-input-group">
                            <label>Paste Exercises in Text Format</label>
                            <textarea id="parserTextInput" rows="12" placeholder="Paste your exercises in this format:&#10;&#10;1. Doorway Stretch&#10;Video: Stop Wasting Time With The Doorway Stretch&#10;Video ID: KcLb7tsGa9M&#10;Timestamps: 0:00 - 0:58&#10;Why it's good: Description here...&#10;&#10;2. Lower Trap Exercise&#10;Video: 5 BEST Lower Trap Exercises&#10;Video ID: -r4YtVumXfM&#10;Timestamps: 1:12 - 1:48&#10;Why it's good: Description here..."></textarea>
                        </div>

                        <div class="text-format-help">
                            <strong style="color:#d8b4fe;">Supported format:</strong><br>
                            1. Exercise Name<br>
                            Video: Video Title (optional)<br>
                            Video ID: YouTube_Video_ID<br>
                            Timestamps: M:SS - M:SS<br>
                            Why it's good: Description text...<br><br>
                            Each exercise separated by a blank line or number.
                        </div>

                        <div style="display: flex; gap: 0.5rem; margin-top: 1rem; margin-bottom: 1rem;">
                            <button class="btn" onclick="parseTextFormat()">
                                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                                Parse Text
                            </button>
                            <button class="btn" style="background: rgba(255,255,255,0.1);" onclick="closeParserModal()">Cancel</button>
                        </div>
                    </div>

                    <div id="parserResults"></div>
                </div>
            </div>

            <!-- Sidebar Toggle (Right) -->
            <button class="sidebar-toggle" onclick="toggleSidebar()">Settings</button>

            <!-- Sidebar Overlay -->
            <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

            <!-- Settings Sidebar -->
            <div class="sidebar" id="settingsSidebar">
                <div class="sidebar-header">
                    <span class="sidebar-title">Settings</span>
                    <button class="sidebar-close" onclick="toggleSidebar()">&times;</button>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-section-title">AI Tools</div>
                    <div class="sidebar-btn-group">
                        <button class="sidebar-btn" onclick="openParserModal()">
                            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                            </svg>
                            YouTube Exercise Parser
                        </button>
                    </div>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-section-title">Display</div>
                    <div class="sidebar-btn-group">
                        <button class="sidebar-btn" id="toggleSlidersBtn" onclick="toggleSliders()">
                            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"/>
                            </svg>
                            <span id="toggleSlidersLabel">Hide Sliders</span>
                        </button>
                    </div>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-section-title">Sequential Player</div>
                    <label class="sidebar-label">Player Position</label>
                    <select class="sidebar-select" id="playerPosition" onchange="changePlayerPosition()">
                        <option value="top">Top</option>
                        <option value="bottom" selected>Bottom Bar (Default)</option>
                        <option value="hidden">Hidden</option>
                    </select>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-section-title">Playback Speed</div>
                    <div style="display: flex; gap: 0.25rem; flex-wrap: wrap;">
                        <button class="speed-btn" onclick="setPlaybackSpeed(0.25)">0.25x</button>
                        <button class="speed-btn" onclick="setPlaybackSpeed(0.5)">0.5x</button>
                        <button class="speed-btn" onclick="setPlaybackSpeed(0.75)">0.75x</button>
                        <button class="speed-btn active" onclick="setPlaybackSpeed(1)" id="speed1x">1x</button>
                        <button class="speed-btn" onclick="setPlaybackSpeed(1.25)">1.25x</button>
                        <button class="speed-btn" onclick="setPlaybackSpeed(1.5)">1.5x</button>
                        <button class="speed-btn" onclick="setPlaybackSpeed(2)">2x</button>
                    </div>
                    <div style="color: #94a3b8; font-size: 0.6rem; margin-top: 0.35rem;">Applies to sequential and all grid players</div>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-section-title">Configuration</div>
                    <label class="sidebar-label">Grid Layout</label>
                    <select class="sidebar-select" id="sidebarLayoutSelect" onchange="changeLayoutFromSidebar(this.value)">
                        <option value="2x5">2 Columns x 5 Rows</option>
                        <option value="5x2" selected>5 Columns x 2 Rows</option>
                    </select>

                    <div class="sidebar-btn-group" style="margin-top: 0.5rem;">
                        <button class="sidebar-btn" onclick="saveCurrentConfig()">
                            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/>
                            </svg>
                            Save Playlist
                        </button>
                        <button class="sidebar-btn" onclick="downloadConfig()">
                            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                            </svg>
                            Download JSON
                        </button>
                        <button class="sidebar-btn" onclick="document.getElementById('configUpload').click()">
                            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                            </svg>
                            Load JSON
                        </button>
                        <button class="sidebar-btn" onclick="resetConfig()" style="border-color:rgba(239,68,68,0.3);">
                            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                            Reset to Default
                        </button>
                    </div>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-section-title">API Key</div>
                    <label class="sidebar-label">Personal Google API Key</label>
                    <input type="password" id="sidebarApiKey" placeholder="Your API key" class="sidebar-select" style="padding:0.4rem 0.5rem;" onchange="savePersonalApiKey(this.value)">
                    <div style="color: #94a3b8; font-size: 0.55rem; margin-top: 0.25rem;">
                        For AI parsing features. <a href="https://ai.google.dev/gemini-api/docs/api-key" target="_blank" style="color:#a855f7;">Get free key</a>
                    </div>
                </div>
            </div>

            <div class="stretch-grid layout-2x5" id="stretchGrid"></div>
        </div>
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        let config = {
            layout: '5x2',
            videoId: '0wAw1-1MHa4',
            stretches: [
                { name: 'Double Knee Rotation', videoId: '0wAw1-1MHa4', start: 138, end: 142, repeat: 3, loop: true, description: 'Lower back stretch - Gently rotates both knees side to side to release tension in the lower back and hips.' },
                { name: 'Single Knee Rotation', videoId: '0wAw1-1MHa4', start: 173, end: 177, repeat: 3, loop: true, description: 'Hip mobility - Rotates one knee at a time in circles to improve hip joint flexibility and range of motion.' },
                { name: 'Single Knee to Chest', videoId: '0wAw1-1MHa4', start: 219, end: 222, repeat: 3, loop: true, description: 'Lower back relief - Pulls one knee toward chest to stretch the lower back and glutes.' },
                { name: 'Double Knee to Chest', videoId: '0wAw1-1MHa4', start: 245, end: 249, repeat: 3, loop: true, description: 'Spine decompression - Hugs both knees to chest to release tension throughout the entire spine.' },
                { name: 'Piriformis Stretch', videoId: '0wAw1-1MHa4', start: 304, end: 309, repeat: 3, loop: true, description: 'Hip and glute stretch - Targets the piriformis muscle deep in the hip to relieve sciatica and hip tightness.' },
                { name: 'Hamstring Stretch', videoId: '0wAw1-1MHa4', start: 368, end: 373, repeat: 3, loop: true, description: 'Leg flexibility - Stretches the hamstrings to improve flexibility and reduce lower back strain.' },
                { name: 'Lower Back Extension', videoId: '0wAw1-1MHa4', start: 442, end: 446, repeat: 3, loop: true, description: 'Spinal extension - Gently arches the back to counteract forward bending and improve posture.' },
                { name: "Child's Pose", videoId: '0wAw1-1MHa4', start: 492, end: 498, repeat: 3, loop: true, description: 'Full body relaxation - Rests in a kneeling position with arms extended to stretch the back and shoulders.' },
                { name: 'Cat/Cow Stretch', videoId: '0wAw1-1MHa4', start: 568, end: 573, repeat: 3, loop: true, description: 'Spine mobility - Alternates between arching and rounding the spine to increase flexibility and circulation.' },
                { name: 'Hip Flexor Stretch', videoId: '0wAw1-1MHa4', start: 607, end: 613, repeat: 3, loop: true, description: 'Hip opener - Stretches the front of the hips to counteract sitting and improve hip extension.' }
            ]
        };

        let slidersVisible = true;
        let playerPosition = 'bottom';
        let currentPlaybackSpeed = 1;
        let gridZoom = 0; // -1=small, 0=normal, 1=large

        // YouTube API Key - injected at deploy time for authenticated users
        const masterYouTubeApiKey = "__YOUTUBE_API_KEY__";

        // Preset configurations
        const presetConfigs = [
            {
                name: "Lower Back Stretches",
                description: "10 stretches for lower back pain relief",
                info: "5 min | No equipment | Daily routine",
                file: "stretch-routine-config.json",
                config: {
                    layout: '5x2',
                    videoId: '0wAw1-1MHa4',
                    stretches: [
                        { name: 'Double Knee Rotation', videoId: '0wAw1-1MHa4', start: 138, end: 142, repeat: 3, loop: true, description: 'Lower back stretch - Gently rotates both knees side to side to release tension in the lower back and hips.' },
                        { name: 'Single Knee Rotation', videoId: '0wAw1-1MHa4', start: 173, end: 177, repeat: 3, loop: true, description: 'Hip mobility - Rotates one knee at a time in circles to improve hip joint flexibility and range of motion.' },
                        { name: 'Single Knee to Chest', videoId: '0wAw1-1MHa4', start: 219, end: 222, repeat: 3, loop: true, description: 'Lower back relief - Pulls one knee toward chest to stretch the lower back and glutes.' },
                        { name: 'Double Knee to Chest', videoId: '0wAw1-1MHa4', start: 245, end: 249, repeat: 3, loop: true, description: 'Spine decompression - Hugs both knees to chest to release tension throughout the entire spine.' },
                        { name: 'Piriformis Stretch', videoId: '0wAw1-1MHa4', start: 304, end: 309, repeat: 3, loop: true, description: 'Hip and glute stretch - Targets the piriformis muscle deep in the hip to relieve sciatica and hip tightness.' },
                        { name: 'Hamstring Stretch', videoId: '0wAw1-1MHa4', start: 368, end: 373, repeat: 3, loop: true, description: 'Leg flexibility - Stretches the hamstrings to improve flexibility and reduce lower back strain.' },
                        { name: 'Lower Back Extension', videoId: '0wAw1-1MHa4', start: 442, end: 446, repeat: 3, loop: true, description: 'Spinal extension - Gently arches the back to counteract forward bending and improve posture.' },
                        { name: "Child's Pose", videoId: '0wAw1-1MHa4', start: 492, end: 498, repeat: 3, loop: true, description: 'Full body relaxation - Rests in a kneeling position with arms extended to stretch the back and shoulders.' },
                        { name: 'Cat/Cow Stretch', videoId: '0wAw1-1MHa4', start: 568, end: 573, repeat: 3, loop: true, description: 'Spine mobility - Alternates between arching and rounding the spine to increase flexibility and circulation.' },
                        { name: 'Hip Flexor Stretch', videoId: '0wAw1-1MHa4', start: 607, end: 613, repeat: 3, loop: true, description: 'Hip opener - Stretches the front of the hips to counteract sitting and improve hip extension.' }
                    ]
                }
            },
            {
                name: "Hip Strengthening",
                description: "9 exercises from basic to advanced",
                info: "20 min | Resistance band + weights | Progressive",
                file: "hip-exercises-config.json",
                config: {
                    layout: '5x2',
                    videoId: 'NkgdllCCrts',
                    stretches: [
                        { name: 'Hip Bridges', videoId: 'NkgdllCCrts', start: 82, end: 148, repeat: 3, loop: true, description: 'Basic / This exercise targets the hip extensors or glute group by lifting the hips off the ground.' },
                        { name: 'Side-Lying Abduction', videoId: 'NkgdllCCrts', start: 149, end: 187, repeat: 3, loop: true, description: 'Basic / This focuses on strengthening the hip abductors by lifting the top leg sideways.' },
                        { name: 'Straight Leg Raises', videoId: 'NkgdllCCrts', start: 188, end: 247, repeat: 3, loop: true, description: 'Basic / This exercise strengthens the hip flexors by raising a straight leg towards the ceiling.' },
                        { name: 'Hip Extension (4-Way)', videoId: 'NkgdllCCrts', start: 283, end: 334, repeat: 3, loop: true, description: 'Intermediate / This exercise involves pulling the leg straight back using a resistance band, targeting the glutes.' },
                        { name: 'Hip Abduction (4-Way)', videoId: 'NkgdllCCrts', start: 335, end: 369, repeat: 3, loop: true, description: 'Intermediate / This involves pulling the leg out to the side, away from the body, using a resistance band.' },
                        { name: 'Hip Flexion (4-Way)', videoId: 'NkgdllCCrts', start: 370, end: 408, repeat: 3, loop: true, description: 'Intermediate / This exercise involves pulling the leg forward using a resistance band, targeting the hip flexors.' },
                        { name: 'Hip Adduction (4-Way)', videoId: 'NkgdllCCrts', start: 409, end: 459, repeat: 3, loop: true, description: 'Intermediate / This involves pulling the leg across the body using a resistance band, targeting the inner thigh muscles.' },
                        { name: 'Deadlift', videoId: 'NkgdllCCrts', start: 531, end: 636, repeat: 3, loop: true, description: 'Advanced / This is a functional movement focusing on hinging at the hips to lift weight, engaging powerful hip muscles.' },
                        { name: 'Squat', videoId: 'NkgdllCCrts', start: 637, end: 689, repeat: 3, loop: true, description: 'Advanced / This is a fundamental movement pattern involving bending at the hips and knees to lower the body.' }
                    ]
                }
            },
            {
                name: "Neck & Upper Back",
                description: "6 exercises for neck pain relief",
                info: "5 min | No equipment | Office-friendly",
                file: "neck-stretches-config.json",
                config: {
                    layout: '5x2',
                    videoId: 'T64es5lGZr8',
                    stretches: [
                        { name: 'Active Motion Warm-Up', videoId: 'T64es5lGZr8', start: 19, end: 81, repeat: 2, loop: true, description: 'Warm-up / Rotation, side bends, flexion/extension, and shoulder rolls. All motions within pain-free range to prepare neck for stretching.' },
                        { name: 'Upper Trap Stretch', videoId: 'T64es5lGZr8', start: 83, end: 139, repeat: 3, loop: true, description: 'Beginner / Tilt ear to shoulder with gentle hand pressure. Stretches from skull base to shoulder tip. Hold 30 seconds each side.' },
                        { name: 'Levator Scapulae Stretch', videoId: 'T64es5lGZr8', start: 140, end: 197, repeat: 3, loop: true, description: 'Intermediate / Look towards pocket and apply gentle pressure to back of head. Targets tension and muscle knots from skull to shoulder blade. Hold 30 seconds each side.' },
                        { name: 'Scalene Stretch', videoId: 'T64es5lGZr8', start: 201, end: 250, repeat: 3, loop: true, description: 'Intermediate / Tilt ear to shoulder then look up. Hands on chest to keep it down. Stretches front neck muscles, pulling chin from collarbone. Hold 30 seconds each side.' },
                        { name: 'Extension Stretch', videoId: 'T64es5lGZr8', start: 261, end: 291, repeat: 3, loop: true, description: 'Upper Back / Hands at neck base, look up into extension. Hold 3-5 seconds, repeat deeper. Helps unround hunched-forward upper back and thoracic spine.' },
                        { name: 'Chin Tucks', videoId: 'T64es5lGZr8', start: 293, end: 318, repeat: 3, loop: true, description: 'Posture Correction / Pull chin straight back away from fingers. Stretches skull base (tension headache area) and retrains front neck muscles for better posture.' }
                    ]
                }
            }
        ];

        let currentPreset = null;

        // Playlist management
        let userPlaylists = JSON.parse(localStorage.getItem('stretchPlaylists') || '[]');
        let currentUser = null;
        let firebaseReady = false;

        function getBuiltinPlaylists() {
            return presetConfigs.map((p, i) => ({
                id: 'builtin-' + i,
                name: p.name,
                description: p.description,
                info: p.info,
                config: p.config,
                type: 'builtin'
            }));
        }

        function saveUserPlaylistsToStorage() {
            localStorage.setItem('stretchPlaylists', JSON.stringify(userPlaylists));
        }

        function openSaveModal() {
            document.getElementById('saveModal').classList.add('open');
            document.getElementById('savePlaylistName').value = '';
            document.getElementById('savePlaylistDesc').value = '';
            document.getElementById('savePlaylistName').focus();
            // Enable cloud checkbox only if signed in
            const cb = document.getElementById('saveToCloud');
            const vis = document.getElementById('cloudCheckbox');
            if (currentUser) {
                cb.disabled = false;
                vis.style.opacity = '1';
            } else {
                cb.disabled = true;
                cb.checked = false;
                vis.style.opacity = '0.4';
            }
        }

        function closeSaveModal() {
            document.getElementById('saveModal').classList.remove('open');
        }

        function confirmSavePlaylist() {
            const name = document.getElementById('savePlaylistName').value.trim();
            if (!name) {
                document.getElementById('savePlaylistName').style.borderColor = '#ef4444';
                return;
            }
            const desc = document.getElementById('savePlaylistDesc').value.trim();
            const toCloud = document.getElementById('saveToCloud').checked && currentUser;

            const playlist = {
                id: 'user-' + Date.now(),
                name: name,
                description: desc || `${config.stretches.length} stretches`,
                config: JSON.parse(JSON.stringify(config)),
                createdAt: new Date().toISOString(),
                type: toCloud ? 'cloud' : 'local'
            };

            if (toCloud && firebaseReady) {
                savePlaylistToFirestore(playlist);
            } else {
                userPlaylists.push(playlist);
                saveUserPlaylistsToStorage();
            }

            closeSaveModal();
            renderAllPlaylists();
            renderPresetList();
        }

        function deleteUserPlaylist(id) {
            if (!confirm('Delete this playlist?')) return;
            userPlaylists = userPlaylists.filter(p => p.id !== id);
            saveUserPlaylistsToStorage();
            renderAllPlaylists();
            renderPresetList();
        }

        function loadPlaylistById(id) {
            // Check built-in
            const builtinIdx = presetConfigs.findIndex((_, i) => 'builtin-' + i === id);
            if (builtinIdx >= 0) {
                loadPreset(builtinIdx);
                return;
            }
            // Check user playlists
            const userPl = userPlaylists.find(p => p.id === id);
            if (userPl) {
                config = JSON.parse(JSON.stringify(userPl.config));
                currentPreset = null;
                document.getElementById('layoutSelect').value = config.layout || '5x2';
                renderGrid();
                initializePlayers();
                updateConfigPreview();
                renderPlaylist();
                renderPresetList();
                renderAllPlaylists();
                document.getElementById('mainTitle').textContent = `Loaded: ${userPl.name}`;
                document.getElementById('mainProgress').textContent = userPl.description;
                setTimeout(() => {
                    if (!sequentialMode.active) {
                        document.getElementById('mainTitle').textContent = 'Sequential Player';
                        document.getElementById('mainProgress').textContent = 'Press Start to begin sequential playback';
                    }
                }, 3000);
            }
        }

        function renderAllPlaylists() {
            // Built-in
            const builtinContainer = document.getElementById('builtinPlaylistList');
            if (builtinContainer) {
                builtinContainer.innerHTML = '';
                presetConfigs.forEach((preset, index) => {
                    const el = document.createElement('div');
                    el.className = 'pl-entry' + (currentPreset === index ? ' active' : '');
                    el.innerHTML = `
                        <div class="pl-entry-info" onclick="loadPlaylistById('builtin-${index}')">
                            <div class="pl-entry-name">${preset.name}</div>
                            <div class="pl-entry-meta">${preset.description}</div>
                        </div>
                    `;
                    builtinContainer.appendChild(el);
                });
            }

            // User local playlists
            const userContainer = document.getElementById('userPlaylistList');
            if (userContainer) {
                userContainer.innerHTML = '';
                const localPls = userPlaylists.filter(p => p.type !== 'cloud');
                if (localPls.length === 0) {
                    userContainer.innerHTML = '<div style="color:#64748b; font-size:0.65rem; padding:0.4rem;">No saved playlists yet. Use Save Config to create one.</div>';
                } else {
                    localPls.forEach(pl => {
                        const el = document.createElement('div');
                        el.className = 'pl-entry';
                        el.innerHTML = `
                            <div class="pl-entry-info" onclick="loadPlaylistById('${pl.id}')">
                                <div class="pl-entry-name">${pl.name}</div>
                                <div class="pl-entry-meta">${pl.description}</div>
                            </div>
                            <div class="pl-entry-actions">
                                <button class="pl-entry-btn delete" onclick="event.stopPropagation();deleteUserPlaylist('${pl.id}')" title="Delete">&#x2715;</button>
                            </div>
                        `;
                        userContainer.appendChild(el);
                    });
                }
            }

            // Cloud playlists - reload if signed in
            if (currentUser && firebaseReady) {
                loadCloudPlaylists();
            }
        }

        function togglePlaylistSidebar() {
            const sidebar = document.getElementById('playlistSidebar');
            const overlay = document.getElementById('plSidebarOverlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('open');
            if (sidebar.classList.contains('open')) {
                renderAllPlaylists();
            }
        }

        // ---- Firebase Auth (Google SSO) + Firestore ----
        // Config values are injected at deploy time from GitHub Secrets.
        // In source code these stay as __PLACEHOLDER__ values (non-functional).
        // The CI/CD pipeline replaces them with real values during deployment.
        // See HOSTING-GUIDE.md for setup instructions.
        const firebaseConfig = {
            apiKey: "__FIREBASE_API_KEY__",
            authDomain: "__FIREBASE_AUTH_DOMAIN__",
            projectId: "__FIREBASE_PROJECT_ID__",
            storageBucket: "__FIREBASE_STORAGE_BUCKET__",
            messagingSenderId: "__FIREBASE_MESSAGING_SENDER_ID__",
            appId: "__FIREBASE_APP_ID__"
        };

        function initFirebase() {
            // Check if Firebase scripts are loaded
            if (typeof firebase === 'undefined') return;
            try {
                firebase.initializeApp(firebaseConfig);
                firebaseReady = true;

                firebase.auth().onAuthStateChanged(user => {
                    currentUser = user;
                    renderAuthBar();
                    if (user) {
                        loadCloudPlaylists();
                    }
                });
            } catch (e) {
                console.log('Firebase not configured yet:', e.message);
            }
        }

        function signInWithGoogle() {
            if (!firebaseReady) {
                alert('Firebase is not configured yet. See the setup guide in README to enable Google Sign-In and cloud playlists.');
                return;
            }
            const provider = new firebase.auth.GoogleAuthProvider();
            firebase.auth().signInWithPopup(provider).catch(err => {
                console.error('Sign-in error:', err);
                alert('Sign-in failed: ' + err.message);
            });
        }

        function signOut() {
            if (firebaseReady) {
                firebase.auth().signOut();
            }
            currentUser = null;
            renderAuthBar();
            document.getElementById('privatePlaylistLabel').style.display = 'none';
            document.getElementById('privatePlaylistList').innerHTML = '';
        }

        function renderAuthBar() {
            const bar = document.getElementById('authContent');
            if (!bar) return;
            if (currentUser) {
                bar.innerHTML = `
                    <div style="display:flex; align-items:center; gap:0.5rem; width:100%;">
                        ${currentUser.photoURL ? `<img class="avatar" src="${currentUser.photoURL}" alt="">` : ''}
                        <span class="user-email">${currentUser.email || currentUser.displayName}</span>
                        <button class="pl-auth-btn" onclick="signOut()">Sign out</button>
                    </div>
                `;
                // Enable cloud save checkbox
                const cb = document.getElementById('saveToCloud');
                const vis = document.getElementById('cloudCheckbox');
                if (cb) { cb.disabled = false; }
                if (vis) { vis.style.opacity = '1'; }
            } else {
                bar.innerHTML = `
                    <button class="pl-google-btn" onclick="signInWithGoogle()">
                        <svg width="16" height="16" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 01-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                        Sign in with Google
                    </button>
                `;
            }
        }

        function savePlaylistToFirestore(playlist) {
            if (!firebaseReady || !currentUser) return;
            const db = firebase.firestore();
            const docData = {
                ...playlist,
                userId: currentUser.uid,
                email: currentUser.email,
                config: JSON.stringify(playlist.config)
            };
            db.collection('playlists').add(docData).then(() => {
                loadCloudPlaylists();
            }).catch(err => {
                console.error('Firestore save error:', err);
                alert('Failed to save to cloud. Saving locally instead.');
                playlist.type = 'local';
                userPlaylists.push(playlist);
                saveUserPlaylistsToStorage();
                renderAllPlaylists();
            });
        }

        function loadCloudPlaylists() {
            if (!firebaseReady || !currentUser) return;
            const db = firebase.firestore();
            document.getElementById('privatePlaylistLabel').style.display = 'block';

            db.collection('playlists')
                .where('userId', '==', currentUser.uid)
                .orderBy('createdAt', 'desc')
                .get()
                .then(snapshot => {
                    const container = document.getElementById('privatePlaylistList');
                    container.innerHTML = '';
                    if (snapshot.empty) {
                        container.innerHTML = '<div style="color:#64748b; font-size:0.65rem; padding:0.4rem;">No cloud playlists. Save with "Save to cloud" checked.</div>';
                        return;
                    }
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const el = document.createElement('div');
                        el.className = 'pl-entry';
                        el.innerHTML = `
                            <div class="pl-entry-info" onclick="loadCloudPlaylist('${doc.id}')">
                                <div class="pl-entry-name">${data.name}</div>
                                <div class="pl-entry-meta">${data.description || ''}</div>
                            </div>
                            <div class="pl-entry-actions">
                                <button class="pl-entry-btn delete" onclick="event.stopPropagation();deleteCloudPlaylist('${doc.id}')" title="Delete">&#x2715;</button>
                            </div>
                        `;
                        container.appendChild(el);
                    });
                })
                .catch(err => {
                    console.error('Firestore load error:', err);
                });
        }

        function loadCloudPlaylist(docId) {
            if (!firebaseReady) return;
            const db = firebase.firestore();
            db.collection('playlists').doc(docId).get().then(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    config = JSON.parse(data.config);
                    currentPreset = null;
                    document.getElementById('layoutSelect').value = config.layout || '5x2';
                    renderGrid();
                    initializePlayers();
                    updateConfigPreview();
                    renderPlaylist();
                    renderPresetList();
                    renderAllPlaylists();
                    document.getElementById('mainTitle').textContent = `Loaded: ${data.name}`;
                    document.getElementById('mainProgress').textContent = data.description || `${config.stretches.length} exercises loaded`;
                    setTimeout(() => {
                        if (!sequentialMode.active) {
                            document.getElementById('mainTitle').textContent = 'Sequential Player';
                            document.getElementById('mainProgress').textContent = 'Press Start to begin sequential playback';
                        }
                    }, 3000);
                }
            });
        }

        function deleteCloudPlaylist(docId) {
            if (!firebaseReady || !confirm('Delete this cloud playlist?')) return;
            const db = firebase.firestore();
            db.collection('playlists').doc(docId).delete().then(() => {
                loadCloudPlaylists();
            });
        }

        // Cloud save checkbox toggle
        document.addEventListener('click', function(e) {
            if (e.target.id === 'cloudCheckbox' || (e.target.closest && e.target.closest('label')?.querySelector('#cloudCheckbox'))) {
                const cb = document.getElementById('saveToCloud');
                const vis = document.getElementById('cloudCheckbox');
                if (!cb.disabled) {
                    cb.checked = !cb.checked;
                    vis.style.background = cb.checked ? 'rgba(168, 85, 247, 0.6)' : 'rgba(0,0,0,0.3)';
                    vis.innerHTML = cb.checked ? '&#10003;' : '';
                    vis.style.color = 'white';
                    vis.style.fontSize = '0.6rem';
                    vis.style.textAlign = 'center';
                    vis.style.lineHeight = '14px';
                }
            }
        });

        let players = [];
        let playerStates = [];
        let mainPlayerObj = null;
        let sequentialMode = {
            active: false,
            currentIndex: 0,
            currentRepeat: 0,
            monitor: null,
            completedStretches: new Set(),
            isPaused: false,
            overallSequenceCount: 0,
            totalSequences: 1
        };

        function renderPlaylist() {
            const container = document.getElementById('playlistItems');
            
            // Add overall progress header
            const overallProgress = document.createElement('div');
            overallProgress.style.cssText = 'background: rgba(168, 85, 247, 0.2); border-radius: 0.5rem; padding: 0.75rem; margin-bottom: 1rem; border: 1px solid rgba(168, 85, 247, 0.4);';
            overallProgress.innerHTML = `
                <div style="color: #d8b4fe; font-size: 0.75rem; margin-bottom: 0.25rem;">Overall Progress</div>
                <div style="color: white; font-size: 1rem; font-weight: 600;">
                    Sequence ${sequentialMode.active ? sequentialMode.overallSequenceCount + 1 : 1}/${sequentialMode.totalSequences}
                </div>
                <div style="color: #e9d5ff; font-size: 0.7rem; margin-top: 0.25rem;">
                    ${sequentialMode.completedStretches.size}/${config.stretches.length} stretches completed
                </div>
            `;
            
            container.innerHTML = '';
            container.appendChild(overallProgress);
            
            config.stretches.forEach((stretch, index) => {
                const item = document.createElement('div');
                item.className = 'playlist-item';
                
                // Mark as current
                if (sequentialMode.active && index === sequentialMode.currentIndex) {
                    item.classList.add('current');
                }
                
                // Mark as completed
                if (sequentialMode.completedStretches.has(index)) {
                    item.classList.add('completed');
                }
                
                const duration = stretch.end - stretch.start;
                const currentRepeat = index === sequentialMode.currentIndex ? sequentialMode.currentRepeat + 1 : 0;
                const repeatText = currentRepeat > 0 ? `${currentRepeat}/${stretch.repeat}` : `0/${stretch.repeat}`;
                
                item.innerHTML = `
                    <div class="playlist-item-header">
                        <span class="playlist-item-number">#${String(index + 1).padStart(2, '0')}</span>
                        ${sequentialMode.completedStretches.has(index) ? '<span style="color: #4ade80;">âœ“</span>' : ''}
                    </div>
                    <div class="playlist-item-name">${stretch.name}</div>
                    <div class="playlist-item-info">
                        <span>${formatTime(duration)}</span>
                        <span class="playlist-item-repeat">${repeatText} repeats</span>
                    </div>
                `;
                
                // Click to jump to this stretch
                item.onclick = () => jumpToStretch(index);
                
                container.appendChild(item);
            });
        }

        function jumpToStretch(index) {
            if (!sequentialMode.active) {
                sequentialMode.active = true;
            }
            
            // Clear existing monitor
            if (sequentialMode.monitor) {
                clearInterval(sequentialMode.monitor);
                sequentialMode.monitor = null;
            }
            
            sequentialMode.currentIndex = index;
            sequentialMode.currentRepeat = 0;
            playCurrentInSequence();
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function setViewMode(mode) {
            const gridBtn = document.getElementById('gridViewBtn');
            const compactBtn = document.getElementById('compactViewBtn');
            const grid = document.getElementById('stretchGrid');

            if (mode === 'compact') {
                compactView = true;
                grid.className = 'stretch-grid layout-compact';
                compactBtn.classList.add('active');
                gridBtn.classList.remove('active');
                document.querySelectorAll('.stretch-card').forEach(card => card.classList.add('compact'));
            } else {
                compactView = false;
                grid.className = `stretch-grid layout-${config.layout}`;
                gridBtn.classList.add('active');
                compactBtn.classList.remove('active');
                document.querySelectorAll('.stretch-card').forEach(card => card.classList.remove('compact'));
            }
            applyZoom();
        }

        function zoomGrid(direction) {
            gridZoom = Math.max(-1, Math.min(1, gridZoom + direction));
            applyZoom();
        }

        function applyZoom() {
            const grid = document.getElementById('stretchGrid');
            grid.classList.remove('zoom-small', 'zoom-large');
            if (gridZoom === -1) grid.classList.add('zoom-small');
            else if (gridZoom === 1) grid.classList.add('zoom-large');
        }

        function changeLayout() {
            config.layout = document.getElementById('layoutSelect').value;
            const sidebarSelect = document.getElementById('sidebarLayoutSelect');
            if (sidebarSelect) sidebarSelect.value = config.layout;
            const grid = document.getElementById('stretchGrid');
            if (!compactView) {
                grid.className = `stretch-grid layout-${config.layout}`;
                applyZoom();
            }
        }

        function changeLayoutFromSidebar(value) {
            config.layout = value;
            document.getElementById('layoutSelect').value = value;
            const grid = document.getElementById('stretchGrid');
            if (!compactView) {
                grid.className = `stretch-grid layout-${config.layout}`;
                applyZoom();
            }
        }

        function renderGrid() {
            const grid = document.getElementById('stretchGrid');
            grid.className = compactView ? 'stretch-grid layout-compact' : `stretch-grid layout-${config.layout}`;
            grid.innerHTML = '';

            // Routine summary bar
            const totalDuration = config.stretches.reduce((sum, s) => sum + (s.end - s.start) * s.repeat, 0);
            const categories = {};
            config.stretches.forEach(s => { const c = s.category || 'general'; categories[c] = (categories[c] || 0) + 1; });
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'routine-summary';
            summaryDiv.style.gridColumn = '1 / -1';
            summaryDiv.innerHTML = `
                <div class="summary-item"><span>Exercises:</span> <span class="summary-value">${config.stretches.length}</span></div>
                <div class="summary-item"><span>Total Duration:</span> <span class="summary-value">${formatTime(totalDuration)}</span></div>
                <div class="summary-item"><span>Categories:</span> ${Object.keys(categories).map(c => `<span class="category-badge ${c}">${c}</span>`).join(' ')}</div>
                <div class="summary-actions">
                    <button class="btn" onclick="openParserModal()" style="font-size:0.65rem; padding:0.25rem 0.5rem;">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:12px;height:12px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                        Parse YouTube
                    </button>
                    <button class="btn" onclick="addExercise()" style="font-size:0.65rem; padding:0.25rem 0.5rem; background:linear-gradient(135deg, #10b981, #059669);">+ Add Exercise</button>
                </div>
            `;
            grid.appendChild(summaryDiv);

            config.stretches.forEach((stretch, index) => {
                const duration = stretch.end - stretch.start;
                const card = document.createElement('div');
                card.className = compactView ? 'stretch-card compact' : 'stretch-card';
                const cat = stretch.category || 'general';
                const diff = stretch.difficulty || 1;

                card.innerHTML = `
                    <div class="stretch-header">
                        <div class="stretch-info">
                            <div class="stretch-number">
                                ${String(index + 1).padStart(2, '0')}
                                <span class="category-badge ${cat}" style="margin-left:0.5rem;">${cat}</span>
                                <span class="difficulty-dots">${[1,2,3].map(d => `<span class="difficulty-dot ${d <= diff ? 'filled' : ''}"></span>`).join('')}</span>
                            </div>
                            <h3 class="stretch-name">${stretch.name}</h3>
                            <div class="stretch-duration">Duration: ${formatTime(duration)} | Repeat: ${stretch.repeat}x ${stretch.loop ? '(âˆž Loop)' : ''}</div>
                            ${stretch.description ? `<div class="stretch-description" style="color: #c4b5fd; font-size: 0.75rem; margin-top: 0.5rem; line-height: 1.4;">${stretch.description}</div>` : ''}
                        </div>
                        <div class="stretch-controls">
                            <button class="loop-toggle ${stretch.loop ? 'active' : ''}" id="loop-${index}" onclick="toggleLoop(${index})">âˆž</button>
                            <button class="sound-toggle" id="sound-${index}" onclick="toggleSound(${index})">
                                <svg class="icon" id="mute-icon-${index}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"/>
                                </svg>
                                <svg class="icon" id="unmute-icon-${index}" style="display:none;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="video-wrapper">
                        <div class="playing-indicator" id="indicator-${index}" style="display:none;"></div>
                        <div class="timer-badge" id="timer-${index}">0:00</div>
                        <div id="player-${index}"></div>
                    </div>
                    <div class="slider-group ${slidersVisible ? '' : 'hidden'}" id="slider-group-${index}">
                        <div class="slider-label">
                            <span>Video ID:</span>
                            <input type="text" class="repeat-input" style="width: 150px; flex: 1;" id="video-input-${index}"
                                   value="${stretch.videoId || config.videoId}"
                                   onchange="updateVideoId(${index}, this.value)"
                                   placeholder="YouTube Video ID">
                        </div>

                        <div class="slider-label" style="margin-top: 0.5rem;">
                            <span>Category:</span>
                            <select class="repeat-input" style="width: 120px;" onchange="updateCategory(${index}, this.value)">
                                <option value="general" ${cat === 'general' ? 'selected' : ''}>General</option>
                                <option value="warmup" ${cat === 'warmup' ? 'selected' : ''}>Warm-up</option>
                                <option value="flexibility" ${cat === 'flexibility' ? 'selected' : ''}>Flexibility</option>
                                <option value="strength" ${cat === 'strength' ? 'selected' : ''}>Strength</option>
                                <option value="balance" ${cat === 'balance' ? 'selected' : ''}>Balance</option>
                                <option value="cooldown" ${cat === 'cooldown' ? 'selected' : ''}>Cool-down</option>
                            </select>
                        </div>

                        <div class="slider-label" style="margin-top: 0.5rem;">
                            <span>Difficulty:</span>
                            <select class="repeat-input" style="width: 100px;" onchange="updateDifficulty(${index}, this.value)">
                                <option value="1" ${diff === 1 ? 'selected' : ''}>Beginner</option>
                                <option value="2" ${diff === 2 ? 'selected' : ''}>Intermediate</option>
                                <option value="3" ${diff === 3 ? 'selected' : ''}>Advanced</option>
                            </select>
                        </div>

                        <div class="slider-label" style="margin-top: 0.75rem;">
                            <span>Description:</span>
                        </div>
                        <textarea class="control-input" id="description-${index}"
                                  style="min-height: 60px; font-size: 0.75rem; resize: vertical;"
                                  onchange="updateDescription(${index}, this.value)"
                                  placeholder="Add a description for this stretch...">${stretch.description || ''}</textarea>

                        <div class="slider-label" style="margin-top: 0.5rem;">
                            <span>Start Time:</span>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <input type="text" class="repeat-input" style="width: 80px;" id="start-input-${index}"
                                       value="${formatTime(stretch.start)}"
                                       onchange="updateStartFromInput(${index}, this.value)"
                                       placeholder="0:00">
                                <span id="start-val-${index}" style="color: #86efac;">${stretch.start}s</span>
                            </div>
                        </div>
                        <input type="range" class="slider" id="start-slider-${index}" min="0" max="3600" value="${stretch.start}"
                               oninput="updateStartFromSlider(${index}, this.value)">

                        <div class="slider-label">
                            <span>End Time:</span>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <input type="text" class="repeat-input" style="width: 80px;" id="end-input-${index}"
                                       value="${formatTime(stretch.end)}"
                                       onchange="updateEndFromInput(${index}, this.value)"
                                       placeholder="0:00">
                                <span id="end-val-${index}" style="color: #86efac;">${stretch.end}s</span>
                            </div>
                        </div>
                        <input type="range" class="slider" id="end-slider-${index}" min="0" max="3600" value="${stretch.end}"
                               oninput="updateEndFromSlider(${index}, this.value)">

                        <div class="slider-label" style="margin-top: 0.5rem;">
                            <span>Repeats (Sequential Mode):</span>
                            <input type="number" class="repeat-input" min="1" max="99" value="${stretch.repeat}"
                                   onchange="updateRepeat(${index}, this.value)">
                        </div>

                        <div class="grid-management-btns">
                            <button class="grid-mgmt-btn" onclick="moveStretchUp(${index})" title="Move Up">â†‘</button>
                            <button class="grid-mgmt-btn" onclick="moveStretchDown(${index})" title="Move Down">â†“</button>
                            <button class="grid-mgmt-btn" onclick="cloneStretch(${index})" title="Clone">Clone</button>
                            <button class="grid-mgmt-btn danger" onclick="deleteStretch(${index})" title="Delete">Delete</button>
                        </div>
                    </div>
                `;

                grid.appendChild(card);
                playerStates[index] = { muted: true, playing: false, monitor: null };
            });

            // Add Exercise card at the end
            const addCard = document.createElement('div');
            addCard.className = 'add-exercise-card';
            addCard.onclick = addExercise;
            addCard.innerHTML = `
                <div class="add-icon">+</div>
                <div class="add-text">Add Exercise</div>
                <div class="add-subtext">Add a blank exercise or use AI Parser</div>
            `;
            grid.appendChild(addCard);
        }

        function timeToSeconds(timeStr) {
            // Convert "M:SS" or "MM:SS" or "H:MM:SS" to seconds
            const parts = timeStr.split(':').map(p => parseInt(p) || 0);
            if (parts.length === 2) {
                return parts[0] * 60 + parts[1];
            } else if (parts.length === 3) {
                return parts[0] * 3600 + parts[1] * 60 + parts[2];
            }
            return parseInt(timeStr) || 0;
        }

        function updateStartFromSlider(index, value) {
            const seconds = parseInt(value);
            config.stretches[index].start = seconds;
            
            // Update both displays
            document.getElementById(`start-val-${index}`).textContent = seconds + 's';
            document.getElementById(`start-input-${index}`).value = formatTime(seconds);
            
            // Update player
            if (players[index]) {
                players[index].seekTo(seconds);
            }
        }

        function updateStartFromInput(index, value) {
            const seconds = timeToSeconds(value);
            config.stretches[index].start = seconds;
            
            // Update slider and displays
            document.getElementById(`start-slider-${index}`).value = seconds;
            document.getElementById(`start-val-${index}`).textContent = seconds + 's';
            document.getElementById(`start-input-${index}`).value = formatTime(seconds);
            
            // Update player
            if (players[index]) {
                players[index].seekTo(seconds);
            }
        }

        function updateEndFromSlider(index, value) {
            const seconds = parseInt(value);
            config.stretches[index].end = seconds;
            
            // Update both displays
            document.getElementById(`end-val-${index}`).textContent = seconds + 's';
            document.getElementById(`end-input-${index}`).value = formatTime(seconds);
        }

        function updateEndFromInput(index, value) {
            const seconds = timeToSeconds(value);
            config.stretches[index].end = seconds;
            
            // Update slider and displays
            document.getElementById(`end-slider-${index}`).value = seconds;
            document.getElementById(`end-val-${index}`).textContent = seconds + 's';
            document.getElementById(`end-input-${index}`).value = formatTime(seconds);
        }

        function updateRepeat(index, value) {
            config.stretches[index].repeat = parseInt(value);
            renderPlaylist();
        }

        function updateDescription(index, value) {
            config.stretches[index].description = value.trim();
            // Update the description display in-place without re-rendering the grid
            const card = document.querySelectorAll('.stretch-card')[index];
            if (card) {
                let descEl = card.querySelector('.stretch-description');
                if (value.trim()) {
                    if (!descEl) {
                        descEl = document.createElement('div');
                        descEl.className = 'stretch-description';
                        descEl.style.cssText = 'color: #c4b5fd; font-size: 0.75rem; margin-top: 0.5rem; line-height: 1.4;';
                        card.querySelector('.stretch-info').appendChild(descEl);
                    }
                    descEl.textContent = value.trim();
                } else if (descEl) {
                    descEl.remove();
                }
            }
        }

        function renderPresetList() {
            const container = document.getElementById('presetList');
            if (!container) return;
            container.innerHTML = '';

            // Built-in playlists
            presetConfigs.forEach((preset, index) => {
                const item = document.createElement('div');
                item.className = 'preset-item';
                if (currentPreset === index) {
                    item.classList.add('active');
                }
                item.innerHTML = `
                    <div class="preset-item-name">${preset.name}</div>
                    <div class="preset-item-desc">${preset.description}</div>
                    <div class="preset-item-info">${preset.info}</div>
                `;
                item.onclick = () => loadPreset(index);
                container.appendChild(item);
            });

            // User playlists
            userPlaylists.forEach(pl => {
                const item = document.createElement('div');
                item.className = 'preset-item';
                item.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:start;">
                        <div>
                            <div class="preset-item-name">${pl.name}</div>
                            <div class="preset-item-desc">${pl.description}</div>
                            <div class="preset-item-info">${pl.type === 'cloud' ? 'Cloud' : 'Local'} | ${new Date(pl.createdAt).toLocaleDateString()}</div>
                        </div>
                        <button class="grid-mgmt-btn danger" onclick="event.stopPropagation();deleteUserPlaylist('${pl.id}')" style="flex-shrink:0;">Delete</button>
                    </div>
                `;
                item.onclick = () => loadPlaylistById(pl.id);
                container.appendChild(item);
            });
        }

        function loadPreset(index) {
            const preset = presetConfigs[index];
            config = JSON.parse(JSON.stringify(preset.config)); // Deep clone
            currentPreset = index;
            
            document.getElementById('layoutSelect').value = config.layout;
            
            renderGrid();
            initializePlayers();
            updateConfigPreview();
            renderPlaylist();
            renderPresetList();
            
            // Show notification
            document.getElementById('mainTitle').textContent = `Loaded: ${preset.name}`;
            document.getElementById('mainProgress').textContent = preset.description;
            setTimeout(() => {
                if (!sequentialMode.active) {
                    document.getElementById('mainTitle').textContent = 'Sequential Player';
                    document.getElementById('mainProgress').textContent = 'Press Start to begin sequential playback';
                }
            }, 3000);
        }

        function cloneStretch(index) {
            const stretch = JSON.parse(JSON.stringify(config.stretches[index])); // Deep clone
            config.stretches.splice(index + 1, 0, stretch);
            renderGrid();
            initializePlayers();
            updateConfigPreview();
            renderPlaylist();
        }

        function deleteStretch(index) {
            if (config.stretches.length <= 1) {
                alert('Cannot delete the last stretch!');
                return;
            }
            
            if (confirm(`Delete "${config.stretches[index].name}"?`)) {
                config.stretches.splice(index, 1);
                renderGrid();
                initializePlayers();
                updateConfigPreview();
                renderPlaylist();
            }
        }

        function moveStretchUp(index) {
            if (index === 0) return; // Already at top
            
            const temp = config.stretches[index];
            config.stretches[index] = config.stretches[index - 1];
            config.stretches[index - 1] = temp;
            
            renderGrid();
            initializePlayers();
            updateConfigPreview();
            renderPlaylist();
        }

        function moveStretchDown(index) {
            if (index === config.stretches.length - 1) return; // Already at bottom
            
            const temp = config.stretches[index];
            config.stretches[index] = config.stretches[index + 1];
            config.stretches[index + 1] = temp;
            
            renderGrid();
            initializePlayers();
            updateConfigPreview();
            renderPlaylist();
        }

        function updateVideoId(index, value) {
            config.stretches[index].videoId = value.trim();
            // Reinitialize this specific player with new video
            if (players[index]) {
                players[index].destroy();
                players[index] = new YT.Player(`player-${index}`, {
                    height: '100%',
                    width: '100%',
                    videoId: value.trim(),
                    playerVars: {
                        'start': config.stretches[index].start,
                        'end': config.stretches[index].end,
                        'autoplay': 0,
                        'controls': 1,
                        'modestbranding': 1,
                        'rel': 0
                    },
                    events: {
                        'onReady': (event) => onPlayerReady(event, index),
                        'onStateChange': (event) => onPlayerStateChange(event, index)
                    }
                });
            }
        }

        function toggleSliders() {
            slidersVisible = !slidersVisible;

            config.stretches.forEach((_, index) => {
                const sliderGroup = document.getElementById(`slider-group-${index}`);
                if (sliderGroup) {
                    if (slidersVisible) {
                        sliderGroup.classList.remove('hidden');
                    } else {
                        sliderGroup.classList.add('hidden');
                    }
                }
            });

            const label = document.getElementById('toggleSlidersLabel');
            if (label) {
                label.textContent = slidersVisible ? 'Hide Sliders' : 'Show Sliders';
            }
        }

        let compactView = false;

        function toggleCompactView() {
            compactView = !compactView;
            const grid = document.getElementById('stretchGrid');
            const tab = document.getElementById('compactToggleTab');

            if (compactView) {
                grid.className = 'stretch-grid layout-compact';
                tab.classList.add('active');
                document.querySelectorAll('.stretch-card').forEach(card => card.classList.add('compact'));
            } else {
                grid.className = `stretch-grid layout-${config.layout}`;
                tab.classList.remove('active');
                document.querySelectorAll('.stretch-card').forEach(card => card.classList.remove('compact'));
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('settingsSidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('open');
        }

        function changePlayerPosition() {
            const position = document.getElementById('playerPosition').value;
            playerPosition = position;
            const player = document.getElementById('sequentialPlayer');

            // Remove all position classes
            player.classList.remove('position-top', 'position-bottom', 'hidden');
            document.body.classList.remove('player-bottom');

            // Add new position class
            if (position === 'hidden') {
                player.classList.add('hidden');
            } else {
                player.classList.add(`position-${position}`);
                if (position === 'bottom') {
                    document.body.classList.add('player-bottom');
                }
            }
        }

        function toggleLoop(index) {
            config.stretches[index].loop = !config.stretches[index].loop;
            const btn = document.getElementById(`loop-${index}`);
            btn.classList.toggle('active');
            renderGrid();
            initializePlayers();
            renderPlaylist();
        }

        function onYouTubeIframeAPIReady() {
            // Set initial body class for bottom player padding
            document.body.classList.add('player-bottom');
            // Load saved API key
            const savedKey = localStorage.getItem('geminiApiKey');
            if (savedKey) {
                const keyInput = document.getElementById('parserApiKey');
                if (keyInput) keyInput.value = savedKey;
                const sidebarKey = document.getElementById('sidebarApiKey');
                if (sidebarKey) sidebarKey.value = savedKey;
            }

            renderGrid();
            initializePlayers();
            updateConfigPreview();
            renderPlaylist();
            renderPresetList();
            renderAllPlaylists();
            initUsageStats();
            updateApiKeyStatus();
        }

        function initializePlayers() {
            // Clear existing players
            players.forEach(p => p && p.destroy());
            players = [];
            
            config.stretches.forEach((stretch, index) => {
                players[index] = new YT.Player(`player-${index}`, {
                    height: '100%',
                    width: '100%',
                    videoId: stretch.videoId || config.videoId,
                    playerVars: {
                        'start': stretch.start,
                        'end': stretch.end,
                        'autoplay': 0,
                        'controls': 1,
                        'modestbranding': 1,
                        'rel': 0
                    },
                    events: {
                        'onReady': (event) => onPlayerReady(event, index),
                        'onStateChange': (event) => onPlayerStateChange(event, index)
                    }
                });
            });

            // Initialize main player
            if (!mainPlayerObj) {
                mainPlayerObj = new YT.Player('mainPlayer', {
                    height: '100%',
                    width: '100%',
                    videoId: config.videoId,
                    playerVars: {
                        'autoplay': 0,
                        'controls': 1,
                        'modestbranding': 1,
                        'rel': 0
                    },
                    events: {
                        'onStateChange': onMainPlayerStateChange
                    }
                });
            }
        }

        function onPlayerReady(event, index) {
            event.target.mute();
            
            setInterval(() => {
                if (playerStates[index].playing) {
                    const currentTime = players[index].getCurrentTime();
                    const elapsed = Math.floor(currentTime - config.stretches[index].start);
                    const duration = config.stretches[index].end - config.stretches[index].start;
                    const remaining = duration - elapsed;
                    
                    if (remaining >= 0) {
                        document.getElementById(`timer-${index}`).textContent = formatTime(remaining);
                    }
                }
            }, 1000);
        }

        function onPlayerStateChange(event, index) {
            const player = event.target;
            const stretch = config.stretches[index];
            
            if (event.data == YT.PlayerState.PLAYING) {
                playerStates[index].playing = true;
                document.getElementById(`indicator-${index}`).style.display = 'block';
                
                // Clear existing monitor if any
                if (playerStates[index].monitor) {
                    clearInterval(playerStates[index].monitor);
                }
                
                // Set up new monitor
                const monitor = setInterval(() => {
                    const currentTime = player.getCurrentTime();
                    
                    // Check if we've reached the end
                    if (currentTime >= stretch.end) {
                        if (stretch.loop) {
                            // Loop enabled - restart from beginning
                            player.seekTo(stretch.start);
                            // Don't stop playing, let it continue
                        } else {
                            // Loop disabled - stop
                            clearInterval(monitor);
                            playerStates[index].monitor = null;
                            player.pauseVideo();
                            player.seekTo(stretch.start);
                        }
                    } else if (currentTime < stretch.start) {
                        // Went before start - seek back to start
                        player.seekTo(stretch.start);
                    }
                }, 100);
                
                playerStates[index].monitor = monitor;
            } else if (event.data == YT.PlayerState.PAUSED || event.data == YT.PlayerState.ENDED) {
                playerStates[index].playing = false;
                document.getElementById(`indicator-${index}`).style.display = 'none';
                
                // Only clear monitor if loop is disabled
                if (!stretch.loop && playerStates[index].monitor) {
                    clearInterval(playerStates[index].monitor);
                    playerStates[index].monitor = null;
                }
            }
        }

        function onMainPlayerStateChange(event) {
            if (event.data == YT.PlayerState.PLAYING && sequentialMode.active && !sequentialMode.isPaused) {
                // Set up a monitor to check if we've reached the end time
                if (sequentialMode.monitor) {
                    clearInterval(sequentialMode.monitor);
                }
                
                sequentialMode.monitor = setInterval(() => {
                    if (!sequentialMode.active || sequentialMode.isPaused) {
                        clearInterval(sequentialMode.monitor);
                        return;
                    }
                    
                    const stretch = config.stretches[sequentialMode.currentIndex];
                    const currentTime = mainPlayerObj.getCurrentTime();
                    
                    // Check if we've reached the end of the current stretch
                    if (currentTime >= stretch.end) {
                        clearInterval(sequentialMode.monitor);
                        playNextInSequence();
                    }
                }, 100);
            } else if (event.data == YT.PlayerState.ENDED && sequentialMode.active && !sequentialMode.isPaused) {
                // Fallback in case the video actually ends
                playNextInSequence();
            } else if (event.data == YT.PlayerState.PAUSED || event.data == YT.PlayerState.ENDED) {
                if (sequentialMode.monitor) {
                    clearInterval(sequentialMode.monitor);
                }
            }
        }

        function toggleSound(index) {
            const player = players[index];
            const soundBtn = document.getElementById(`sound-${index}`);
            const muteIcon = document.getElementById(`mute-icon-${index}`);
            const unmuteIcon = document.getElementById(`unmute-icon-${index}`);
            
            if (playerStates[index].muted) {
                players.forEach((p, i) => {
                    if (i !== index) {
                        p.mute();
                        playerStates[i].muted = true;
                        document.getElementById(`sound-${i}`).classList.remove('unmuted');
                        document.getElementById(`mute-icon-${i}`).style.display = 'block';
                        document.getElementById(`unmute-icon-${i}`).style.display = 'none';
                    }
                });
                
                player.unMute();
                playerStates[index].muted = false;
                soundBtn.classList.add('unmuted');
                muteIcon.style.display = 'none';
                unmuteIcon.style.display = 'block';
            } else {
                player.mute();
                playerStates[index].muted = true;
                soundBtn.classList.remove('unmuted');
                muteIcon.style.display = 'block';
                unmuteIcon.style.display = 'none';
            }
        }

        function playAllGrid() {
            players.forEach((player, index) => {
                player.mute();
                playerStates[index].muted = true;
                player.seekTo(config.stretches[index].start);
                player.playVideo();
                
                document.getElementById(`sound-${index}`).classList.remove('unmuted');
                document.getElementById(`mute-icon-${index}`).style.display = 'block';
                document.getElementById(`unmute-icon-${index}`).style.display = 'none';
            });
        }

        function stopAllGrid() {
            players.forEach((player, index) => {
                player.pauseVideo();
                player.seekTo(config.stretches[index].start);
                document.getElementById(`timer-${index}`).textContent = formatTime(config.stretches[index].end - config.stretches[index].start);
            });
        }

        function muteAllGrid() {
            players.forEach((player, index) => {
                player.mute();
                playerStates[index].muted = true;
                
                document.getElementById(`sound-${index}`).classList.remove('unmuted');
                document.getElementById(`mute-icon-${index}`).style.display = 'block';
                document.getElementById(`unmute-icon-${index}`).style.display = 'none';
            });
        }

        function startSequential() {
            // Clear any existing monitor
            if (sequentialMode.monitor) {
                clearInterval(sequentialMode.monitor);
                sequentialMode.monitor = null;
            }
            
            sequentialMode.active = true;
            sequentialMode.currentIndex = 0;
            sequentialMode.currentRepeat = 0;
            sequentialMode.completedStretches.clear();
            sequentialMode.isPaused = false;
            sequentialMode.overallSequenceCount = 0;
            sequentialMode.totalSequences = parseInt(document.getElementById('overallRepeats').value) || 1;
            
            renderPlaylist();
            playCurrentInSequence();
        }

        function playCurrentInSequence() {
            if (sequentialMode.currentIndex >= config.stretches.length) {
                stopSequential();
                return;
            }

            const stretch = config.stretches[sequentialMode.currentIndex];
            const repeatText = `(Repeat ${sequentialMode.currentRepeat + 1}/${stretch.repeat})`;
            const overallText = `[Sequence ${sequentialMode.overallSequenceCount + 1}/${sequentialMode.totalSequences}]`;
            
            document.getElementById('mainTitle').textContent = stretch.name;
            document.getElementById('mainProgress').textContent = 
                `Stretch ${sequentialMode.currentIndex + 1}/${config.stretches.length} ${repeatText} ${overallText}`;
            
            // Update playlist display
            renderPlaylist();
            
            // Use the stretch's specific video ID or fall back to global
            const videoId = stretch.videoId || config.videoId;
            
            mainPlayerObj.loadVideoById({
                videoId: videoId,
                startSeconds: stretch.start,
                endSeconds: stretch.end
            });
            
            // Ensure video plays
            setTimeout(() => {
                mainPlayerObj.playVideo();
            }, 100);
        }

        function playNextInSequence() {
            if (!sequentialMode.active) return;
            
            // Clear any existing monitor
            if (sequentialMode.monitor) {
                clearInterval(sequentialMode.monitor);
                sequentialMode.monitor = null;
            }
            
            const stretch = config.stretches[sequentialMode.currentIndex];
            sequentialMode.currentRepeat++;
            
            // Continue repeating current stretch if not done
            if (sequentialMode.currentRepeat < stretch.repeat) {
                // Get pause duration for REPEATS (same stretch)
                const pauseDuration = parseInt(document.getElementById('pauseRepeat').value) || 0;
                
                // Show pause indicator
                if (pauseDuration > 0) {
                    sequentialMode.isPaused = true;
                    document.getElementById('mainTitle').textContent = `Pausing...`;
                    document.getElementById('mainProgress').textContent = 
                        `${pauseDuration} seconds until next repeat of ${stretch.name}`;
                    renderPlaylist();
                    
                    // Wait for pause duration then continue
                    setTimeout(() => {
                        sequentialMode.isPaused = false;
                        playCurrentInSequence();
                    }, pauseDuration * 1000);
                } else {
                    playCurrentInSequence();
                }
            } else {
                // Mark current stretch as completed
                sequentialMode.completedStretches.add(sequentialMode.currentIndex);
                
                // Move to next stretch
                sequentialMode.currentRepeat = 0;
                sequentialMode.currentIndex++;
                
                // Check if we've completed all stretches in this sequence
                if (sequentialMode.currentIndex >= config.stretches.length) {
                    // Completed one full sequence
                    sequentialMode.overallSequenceCount++;
                    
                    // Check if we need to repeat the entire sequence
                    if (sequentialMode.overallSequenceCount < sequentialMode.totalSequences) {
                        // Start over from the beginning
                        sequentialMode.currentIndex = 0;
                        sequentialMode.currentRepeat = 0;
                        sequentialMode.completedStretches.clear();
                        
                        // Get pause duration for VIDEO transitions
                        const pauseDuration = parseInt(document.getElementById('pauseVideo').value) || 0;
                        
                        if (pauseDuration > 0) {
                            sequentialMode.isPaused = true;
                            document.getElementById('mainTitle').textContent = `Sequence ${sequentialMode.overallSequenceCount}/${sequentialMode.totalSequences} Complete! ðŸŽ‰`;
                            document.getElementById('mainProgress').textContent = 
                                `Starting sequence ${sequentialMode.overallSequenceCount + 1} in ${pauseDuration} seconds...`;
                            renderPlaylist();
                            
                            setTimeout(() => {
                                sequentialMode.isPaused = false;
                                playCurrentInSequence();
                            }, pauseDuration * 1000);
                        } else {
                            playCurrentInSequence();
                        }
                    } else {
                        // All sequences complete!
                        stopSequential();
                        document.getElementById('mainTitle').textContent = `All Sequences Complete! ðŸŽ‰ðŸŽ‰`;
                        document.getElementById('mainProgress').textContent = 
                            `Completed ${sequentialMode.totalSequences} full routine(s)!`;
                        renderPlaylist();
                    }
                } else {
                    // Moving to next stretch in same sequence
                    // Get pause duration for VIDEO transitions
                    const pauseDuration = parseInt(document.getElementById('pauseVideo').value) || 0;
                    const nextStretch = config.stretches[sequentialMode.currentIndex];
                    
                    if (pauseDuration > 0) {
                        sequentialMode.isPaused = true;
                        document.getElementById('mainTitle').textContent = `Pausing...`;
                        document.getElementById('mainProgress').textContent = 
                            `${pauseDuration} seconds until ${nextStretch.name}`;
                        renderPlaylist();
                        
                        setTimeout(() => {
                            sequentialMode.isPaused = false;
                            playCurrentInSequence();
                        }, pauseDuration * 1000);
                    } else {
                        playCurrentInSequence();
                    }
                }
            }
        }

        function stopSequential() {
            sequentialMode.active = false;
            sequentialMode.isPaused = false;
            if (sequentialMode.monitor) {
                clearInterval(sequentialMode.monitor);
                sequentialMode.monitor = null;
            }
            mainPlayerObj.stopVideo();
            document.getElementById('mainTitle').textContent = 'Stopped';
            document.getElementById('mainProgress').textContent = 'Press Start to restart';
            renderPlaylist();
        }

        function skipNext() {
            if (sequentialMode.active) {
                // Clear existing monitor
                if (sequentialMode.monitor) {
                    clearInterval(sequentialMode.monitor);
                    sequentialMode.monitor = null;
                }
                
                sequentialMode.currentRepeat = 0;
                sequentialMode.currentIndex++;
                playCurrentInSequence();
            }
        }

        function saveCurrentConfig() {
            updateConfigPreview();
            openSaveModal();
        }

        function updateConfigPreview() {
            const preview = document.getElementById('configPreview');
            if (preview) preview.value = JSON.stringify(config, null, 2);
            const layoutSelect = document.getElementById('layoutSelect');
            if (layoutSelect) layoutSelect.value = config.layout;
            const sidebarLayout = document.getElementById('sidebarLayoutSelect');
            if (sidebarLayout) sidebarLayout.value = config.layout;
        }

        function downloadConfig() {
            const name = prompt('Playlist name for the downloaded file:', 'stretch-routine');
            if (name === null) return;
            const dataStr = JSON.stringify(config, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = (name.trim() || 'stretch-routine') + '-config.json';
            link.click();
            URL.revokeObjectURL(url);
        }

        function loadConfig(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const loadedConfig = JSON.parse(e.target.result);
                        const name = prompt('Name this playlist:', file.name.replace(/\.json$/i, '').replace(/-config$/i, ''));
                        if (name === null) return;

                        config = loadedConfig;
                        currentPreset = null;
                        document.getElementById('layoutSelect').value = config.layout || '5x2';
                        renderGrid();
                        initializePlayers();
                        updateConfigPreview();
                        renderPlaylist();
                        renderPresetList();

                        // Add to user playlists
                        if (name.trim()) {
                            const playlist = {
                                id: 'user-' + Date.now(),
                                name: name.trim(),
                                description: `${config.stretches.length} stretches - Imported from file`,
                                config: JSON.parse(JSON.stringify(config)),
                                createdAt: new Date().toISOString(),
                                type: 'local'
                            };
                            userPlaylists.push(playlist);
                            saveUserPlaylistsToStorage();
                            renderAllPlaylists();
                        }
                    } catch (error) {
                        alert('Error loading configuration: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }
        }

        function resetConfig() {
            if (confirm('Are you sure you want to reset to default configuration?')) {
                loadPreset(0);
            }
        }

        // ---- Playback Speed Control ----
        function changePlaybackSpeed(delta) {
            const speeds = [0.25, 0.5, 0.75, 1, 1.25, 1.5, 1.75, 2];
            let currentIdx = speeds.indexOf(currentPlaybackSpeed);
            if (currentIdx === -1) currentIdx = speeds.findIndex(s => s >= currentPlaybackSpeed);
            const newIdx = Math.max(0, Math.min(speeds.length - 1, currentIdx + (delta > 0 ? 1 : -1)));
            setPlaybackSpeed(speeds[newIdx]);
        }

        function setPlaybackSpeed(speed) {
            currentPlaybackSpeed = speed;
            // Apply to main sequential player
            if (mainPlayerObj && typeof mainPlayerObj.setPlaybackRate === 'function') {
                mainPlayerObj.setPlaybackRate(speed);
            }
            // Apply to all grid players
            players.forEach(p => {
                if (p && typeof p.setPlaybackRate === 'function') {
                    p.setPlaybackRate(speed);
                }
            });
            // Update displays
            const display = document.getElementById('speedDisplay');
            if (display) display.textContent = speed + 'x';
            const fcDisplay = document.getElementById('fcSpeedDisplay');
            if (fcDisplay) fcDisplay.textContent = speed + 'x';
            // Update sidebar speed buttons
            document.querySelectorAll('.sidebar-section .speed-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.trim() === speed + 'x') {
                    btn.classList.add('active');
                }
            });
        }

        // ---- Category & Difficulty Management ----
        function updateCategory(index, value) {
            config.stretches[index].category = value;
            renderGrid();
            initializePlayers();
            renderPlaylist();
        }

        function updateDifficulty(index, value) {
            config.stretches[index].difficulty = parseInt(value);
            renderGrid();
            initializePlayers();
            renderPlaylist();
        }

        // ---- Add Exercise ----
        function addExercise() {
            const newExercise = {
                name: 'New Exercise',
                videoId: config.videoId || 'dQw4w9WgXcQ',
                start: 0,
                end: 30,
                repeat: 3,
                loop: true,
                description: '',
                category: 'general',
                difficulty: 1
            };
            config.stretches.push(newExercise);
            renderGrid();
            initializePlayers();
            updateConfigPreview();
            renderPlaylist();
            // Scroll to the new card
            setTimeout(() => {
                const cards = document.querySelectorAll('.stretch-card');
                if (cards.length > 0) {
                    cards[cards.length - 1].scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 300);
        }

        // ---- YouTube Parser Modal ----
        function openParserModal() {
            document.getElementById('parserModal').classList.add('open');
            const savedKey = localStorage.getItem('geminiApiKey');
            if (savedKey) {
                document.getElementById('parserApiKey').value = savedKey;
            }
            updateApiKeyStatus();
            trackEvent('open_parser', 'tools', 'parser_modal');
        }

        function closeParserModal() {
            document.getElementById('parserModal').classList.remove('open');
        }

        function extractVideoId(url) {
            url = url.trim();
            // Handle various YouTube URL formats
            const patterns = [
                /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/|youtube\.com\/v\/)([a-zA-Z0-9_-]{11})/,
                /^([a-zA-Z0-9_-]{11})$/
            ];
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match) return match[1];
            }
            return null;
        }

        async function parseYouTubeExercises() {
            const urlsText = (document.getElementById('parserAiUrls')?.value || '').trim();
            const transcript = document.getElementById('parserTranscript').value.trim();
            const apiKey = document.getElementById('parserApiKey').value.trim() || getActiveApiKey();
            const context = document.getElementById('parserContext').value;
            const resultsDiv = document.getElementById('parserResults');

            if (!apiKey) {
                alert('Please enter your Gemini API key. You can get a free key at ai.google.dev');
                return;
            }

            // Save API key for future use
            localStorage.setItem('geminiApiKey', apiKey);

            if (!transcript) {
                alert('Please paste the video transcript. Open the YouTube video, click "..." > "Show transcript", then copy and paste the text here.');
                return;
            }

            // Extract video IDs from URLs
            const urls = urlsText.split('\n').filter(u => u.trim());
            const videoIds = urls.map(extractVideoId).filter(Boolean);
            const videoId = videoIds.length > 0 ? videoIds[0] : null;

            // Show loading
            resultsDiv.innerHTML = `
                <div class="parser-loading">
                    <div class="spinner"></div>
                    <div>Analyzing transcript with AI...</div>
                    <div style="font-size:0.7rem; color:#94a3b8; margin-top:0.5rem;">Extracting exercises, timing, and descriptions</div>
                </div>
            `;

            const contextPrompts = {
                general: 'exercise or stretch routine',
                physiotherapy: 'physiotherapy rehabilitation exercises. Include any therapeutic notes, contraindications, or muscle groups targeted',
                gym: 'gym workout or strength training exercises. Include sets, reps, and target muscle groups where mentioned',
                dance: 'dance practice or choreography segments. Include the dance style and movement descriptions',
                yoga: 'yoga poses and sequences. Include Sanskrit names if mentioned and breathing instructions'
            };

            const prompt = `Analyze this YouTube video transcript and extract all individual exercises, stretches, or movements as a structured routine.

Context: This is a ${contextPrompts[context]}.

For EACH exercise/movement found, provide:
- "name": A clear, concise name for the exercise
- "start": Start time in seconds (convert from timestamp format)
- "end": End time in seconds (when the exercise segment ends or the next one begins)
- "description": A helpful description of how to perform the exercise, including any cues from the instructor
- "repeat": Suggested number of repetitions (default 3 if not specified)
- "category": One of "warmup", "flexibility", "strength", "balance", "cooldown" (pick the most appropriate)
- "difficulty": 1 for beginner, 2 for intermediate, 3 for advanced

Return ONLY a valid JSON array of objects. No markdown, no explanation, just the JSON array.

Example format:
[{"name":"Exercise Name","start":60,"end":120,"description":"Description here","repeat":3,"category":"flexibility","difficulty":1}]

Transcript:
${transcript}`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: {
                            temperature: 0.3,
                            maxOutputTokens: 8192
                        }
                    })
                });

                if (!response.ok) {
                    const errData = await response.json().catch(() => ({}));
                    throw new Error(errData.error?.message || `API error: ${response.status}`);
                }

                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';

                // Extract JSON from the response (handle potential markdown wrapping)
                let jsonStr = text.trim();
                const jsonMatch = jsonStr.match(/\[[\s\S]*\]/);
                if (jsonMatch) {
                    jsonStr = jsonMatch[0];
                }

                const exercises = JSON.parse(jsonStr);

                if (!Array.isArray(exercises) || exercises.length === 0) {
                    throw new Error('No exercises found in the transcript');
                }

                // Display results
                resultsDiv.innerHTML = `
                    <div style="color: #4ade80; font-size: 0.8rem; margin-bottom: 0.75rem; font-weight: 600;">
                        Found ${exercises.length} exercises
                    </div>
                    ${exercises.map((ex, i) => `
                        <div class="parser-exercise-item">
                            <div class="exercise-name">
                                ${i + 1}. ${ex.name}
                                <span class="category-badge ${ex.category || 'general'}" style="margin-left:0.5rem;">${ex.category || 'general'}</span>
                            </div>
                            <div class="exercise-time">${formatTime(ex.start)} - ${formatTime(ex.end)} (${formatTime(ex.end - ex.start)}) | ${ex.repeat || 3}x repeats</div>
                            <div class="exercise-desc">${ex.description || ''}</div>
                        </div>
                    `).join('')}
                    <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                        <button class="btn" onclick="applyParsedExercises()" id="applyParsedBtn">
                            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                            Replace Current Routine
                        </button>
                        <button class="btn secondary" onclick="appendParsedExercises()">
                            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
                            Add to Current Routine
                        </button>
                    </div>
                `;

                // Store parsed exercises for later use
                window._parsedExercises = exercises.map(ex => ({
                    name: ex.name,
                    videoId: videoId || config.videoId,
                    start: Math.round(ex.start),
                    end: Math.round(ex.end),
                    repeat: ex.repeat || 3,
                    loop: true,
                    description: ex.description || '',
                    category: ex.category || 'general',
                    difficulty: ex.difficulty || 1
                }));

            } catch (err) {
                resultsDiv.innerHTML = `
                    <div style="color: #f87171; padding: 1rem;">
                        <div style="font-weight: 600; margin-bottom: 0.5rem;">Error parsing exercises</div>
                        <div style="font-size: 0.75rem;">${err.message}</div>
                        <div style="font-size: 0.7rem; color: #94a3b8; margin-top: 0.5rem;">
                            Make sure your API key is valid and the transcript is properly pasted.
                        </div>
                    </div>
                `;
            }
        }

        function applyParsedExercises() {
            if (!window._parsedExercises || window._parsedExercises.length === 0) return;
            config.stretches = window._parsedExercises;
            closeParserModal();
            renderGrid();
            initializePlayers();
            updateConfigPreview();
            renderPlaylist();
        }

        function appendParsedExercises() {
            if (!window._parsedExercises || window._parsedExercises.length === 0) return;
            config.stretches = config.stretches.concat(window._parsedExercises);
            closeParserModal();
            renderGrid();
            initializePlayers();
            updateConfigPreview();
            renderPlaylist();
        }

        // ---- Parser Mode Switching ----
        function switchParserMode(mode) {
            document.querySelectorAll('.parser-mode-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.parser-mode-content').forEach(c => c.classList.remove('active'));

            const modeMap = { manual: 0, ai: 1, text: 2 };
            document.querySelectorAll('.parser-mode-btn')[modeMap[mode]].classList.add('active');
            document.getElementById('parserManualMode').classList.toggle('active', mode === 'manual');
            document.getElementById('parserAiMode').classList.toggle('active', mode === 'ai');
            document.getElementById('parserTextMode').classList.toggle('active', mode === 'text');
        }

        // ---- Manual URL Parser ----
        function parseManualUrls() {
            const urlsText = document.getElementById('parserUrls').value.trim();
            if (!urlsText) {
                alert('Please enter at least one YouTube URL');
                return;
            }

            const urls = urlsText.split('\n').filter(u => u.trim());
            const exercises = [];

            urls.forEach((url, i) => {
                const videoId = extractVideoId(url.trim());
                if (videoId) {
                    exercises.push({
                        name: `Video ${i + 1}`,
                        videoId: videoId,
                        start: 0,
                        end: 60,
                        repeat: 3,
                        loop: true,
                        description: '',
                        category: 'general',
                        difficulty: 1
                    });
                }
            });

            if (exercises.length === 0) {
                alert('No valid YouTube URLs found');
                return;
            }

            window._parsedExercises = exercises;
            const resultsDiv = document.getElementById('parserResults');
            resultsDiv.innerHTML = `
                <div style="color: #4ade80; font-size: 0.8rem; margin-bottom: 0.75rem; font-weight: 600;">
                    Added ${exercises.length} video(s) - edit start/end times in the grid
                </div>
                ${exercises.map((ex, i) => `
                    <div class="parser-exercise-item">
                        <div class="exercise-name">${i + 1}. ${ex.name} <span style="color:#94a3b8; font-size:0.7rem;">(${ex.videoId})</span></div>
                        <div class="exercise-time">0:00 - 1:00 | Edit in grid after adding</div>
                    </div>
                `).join('')}
                <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn" onclick="applyParsedExercises()">Replace Current</button>
                    <button class="btn secondary" onclick="appendParsedExercises()">Add to Current</button>
                </div>
            `;
        }

        // ---- Text Format Parser ----
        function parseTextFormat() {
            const text = document.getElementById('parserTextInput').value.trim();
            if (!text) {
                alert('Please paste exercises in the text format');
                return;
            }

            const exercises = [];
            // Split by numbered entries (e.g., "1.", "2.", etc.)
            const entries = text.split(/(?=^\d+\.\s)/m).filter(e => e.trim());

            entries.forEach(entry => {
                const lines = entry.trim().split('\n').map(l => l.trim());
                if (lines.length === 0) return;

                // Parse exercise name from first line
                const nameMatch = lines[0].match(/^\d+\.\s*(.+)/);
                if (!nameMatch) return;
                const name = nameMatch[1].trim();

                let videoId = '';
                let start = 0;
                let end = 60;
                let description = '';

                lines.forEach(line => {
                    // Video ID
                    const idMatch = line.match(/Video\s*ID:\s*([a-zA-Z0-9_-]+)/i);
                    if (idMatch) videoId = idMatch[1];

                    // Timestamps: M:SS - M:SS or MM:SS - MM:SS
                    const tsMatch = line.match(/Timestamps?:\s*(\d+:\d+)\s*-\s*(\d+:\d+)/i);
                    if (tsMatch) {
                        start = timeToSeconds(tsMatch[1]);
                        end = timeToSeconds(tsMatch[2]);
                    }

                    // Description lines
                    const descMatch = line.match(/(?:Why it'?s? good|Description|Notes?):\s*(.+)/i);
                    if (descMatch) {
                        description = descMatch[1].trim();
                    }
                });

                if (videoId || name) {
                    exercises.push({
                        name: name,
                        videoId: videoId || config.videoId,
                        start: start,
                        end: end,
                        repeat: 3,
                        loop: true,
                        description: description,
                        category: 'general',
                        difficulty: 1
                    });
                }
            });

            if (exercises.length === 0) {
                alert('Could not parse any exercises from the text. Check the format.');
                return;
            }

            window._parsedExercises = exercises;
            const resultsDiv = document.getElementById('parserResults');
            resultsDiv.innerHTML = `
                <div style="color: #4ade80; font-size: 0.8rem; margin-bottom: 0.75rem; font-weight: 600;">
                    Parsed ${exercises.length} exercises from text
                </div>
                ${exercises.map((ex, i) => `
                    <div class="parser-exercise-item">
                        <div class="exercise-name">${i + 1}. ${ex.name}</div>
                        <div class="exercise-time">${formatTime(ex.start)} - ${formatTime(ex.end)} | Video: ${ex.videoId}</div>
                        ${ex.description ? `<div class="exercise-desc">${ex.description}</div>` : ''}
                    </div>
                `).join('')}
                <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn" onclick="applyParsedExercises()">Replace Current Routine</button>
                    <button class="btn secondary" onclick="appendParsedExercises()">Add to Current Routine</button>
                </div>
            `;
        }

        // ---- API Key Management ----
        function getActiveApiKey() {
            // Priority: 1) Master key for authenticated users, 2) Personal key
            if (currentUser && masterYouTubeApiKey && !masterYouTubeApiKey.startsWith('__')) {
                return masterYouTubeApiKey;
            }
            return localStorage.getItem('geminiApiKey') || '';
        }

        function savePersonalApiKey(key) {
            localStorage.setItem('geminiApiKey', key.trim());
            const parserKey = document.getElementById('parserApiKey');
            if (parserKey) parserKey.value = key.trim();
            updateApiKeyStatus();
        }

        function updateApiKeyStatus() {
            const statusEl = document.getElementById('apiKeyStatus');
            const masterInfo = document.getElementById('masterKeyInfo');
            if (!statusEl) return;

            const hasMasterKey = currentUser && masterYouTubeApiKey && !masterYouTubeApiKey.startsWith('__');
            const hasPersonalKey = !!localStorage.getItem('geminiApiKey');

            if (hasMasterKey) {
                statusEl.textContent = 'Master key active';
                statusEl.className = 'key-status active';
                if (masterInfo) masterInfo.style.display = 'block';
            } else if (hasPersonalKey) {
                statusEl.textContent = 'Personal key set';
                statusEl.className = 'key-status active';
                if (masterInfo) masterInfo.style.display = 'none';
            } else {
                statusEl.textContent = 'Not set';
                statusEl.className = 'key-status inactive';
                if (masterInfo) masterInfo.style.display = 'none';
            }
        }

        // ---- Usage Stats (Social Proof) ----
        function initUsageStats() {
            const statsEl = document.getElementById('usageText');
            if (!statsEl) return;

            // Get or create session-based stats from localStorage
            let stats = JSON.parse(localStorage.getItem('usageStats') || '{}');
            const today = new Date().toDateString();

            if (stats.date !== today) {
                stats = {
                    date: today,
                    routinesCreated: Math.floor(Math.random() * 150) + 350,
                    activeUsers: Math.floor(Math.random() * 50) + 80
                };
            }

            // Increment on session
            stats.routinesCreated = (stats.routinesCreated || 400) + 1;
            localStorage.setItem('usageStats', JSON.stringify(stats));

            statsEl.textContent = `${stats.routinesCreated}+ routines built today`;
        }

        // Track events for analytics
        function trackEvent(action, category, label) {
            if (typeof gtag === 'function') {
                gtag('event', action, {
                    event_category: category,
                    event_label: label
                });
            }
        }
    </script>

    <!-- Firebase SDK - loads only when config has been injected by CI/CD -->
    <!-- __FIREBASE_SCRIPTS_START__
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script>initFirebase();</script>
    __FIREBASE_SCRIPTS_END__ -->

</body>
</html>
